<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>認証＆データ取得テスト</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; }
        button { padding: 10px 20px; margin: 10px; cursor: pointer; background: #667eea; color: white; border: none; border-radius: 5px; }
        button:hover { background: #5563d1; }
        pre { background: #f0f0f0; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>認証＆Shopify顧客データ取得テスト</h1>

        <div>
            <h2>Step 1: ログイン</h2>
            <p>ユーザー名: admin / パスワード: #collection30</p>
            <button onclick="doLogin()">ログイン実行</button>
            <div id="loginResult"></div>
        </div>

        <div>
            <h2>Step 2: Shopify顧客データ取得</h2>
            <button onclick="fetchCustomers()">顧客データ取得</button>
            <div id="customerResult"></div>
        </div>

        <div>
            <h2>Step 3: customers.htmlへアクセス</h2>
            <a href="/customers.html" target="_blank">
                <button>customers.htmlを開く</button>
            </a>
        </div>
    </div>

    <script>
        // ログイン処理
        async function doLogin() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.innerHTML = '<p>ログイン中...</p>';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'admin',
                        password: '#collection30'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // トークンをローカルストレージに保存
                    localStorage.setItem('kanucard_admin_token', data.data.token);
                    localStorage.setItem('kanucard_refresh_token', data.data.refreshToken);
                    localStorage.setItem('kanucard_user_data', JSON.stringify(data.data.user));

                    resultDiv.innerHTML = `
                        <p class="success">✅ ログイン成功！</p>
                        <pre>${JSON.stringify(data.data.user, null, 2)}</pre>
                        <p>トークンがローカルストレージに保存されました。</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">❌ ログイン失敗: ${data.message || 'Unknown error'}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">❌ エラー: ${error.message}</p>`;
            }
        }

        // 顧客データ取得
        async function fetchCustomers() {
            const resultDiv = document.getElementById('customerResult');
            resultDiv.innerHTML = '<p>データ取得中...</p>';

            const token = localStorage.getItem('kanucard_admin_token');

            if (!token) {
                resultDiv.innerHTML = '<p class="error">❌ トークンがありません。先にログインしてください。</p>';
                return;
            }

            try {
                const response = await fetch('/api/shopify/customers', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const customers = data.data.customers || [];
                    resultDiv.innerHTML = `
                        <p class="success">✅ 顧客データ取得成功！</p>
                        <p>取得件数: ${customers.length}件</p>
                        <pre>${JSON.stringify(customers.slice(0, 3), null, 2)}</pre>
                        <p>（最初の3件のみ表示）</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">❌ 取得失敗: ${data.message || 'Unknown error'}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">❌ エラー: ${error.message}</p>`;
            }
        }

        // ページ読み込み時にトークンの状態を確認
        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('kanucard_admin_token');
            if (token) {
                document.getElementById('loginResult').innerHTML = '<p class="success">既存のトークンが見つかりました。</p>';
            }
        });
    </script>
</body>
</html>