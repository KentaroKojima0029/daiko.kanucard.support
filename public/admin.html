<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSA代行サービス 総合管理システム</title>

    <!-- APIクライアント読み込み -->
    <script src="/js/api-config.js"></script>
    <script src="/js/api-client.js"></script>
    <script src="/js/api-auth.js"></script>
    <script src="/js/api-admin.js"></script>
    <script src="/js/api-forms.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        /* ヘッダー */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header-stats {
            display: flex;
            gap: 30px;
            margin-top: 15px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        /* メインコンテナ */
        .main-container {
            display: flex;
            height: calc(100vh - 120px);
        }

        /* サイドバー */
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .nav-item:hover {
            background: #f8f9fa;
        }

        .nav-item.active {
            background: #f0f4ff;
            border-left-color: #667eea;
        }

        .nav-item i {
            width: 20px;
            margin-right: 10px;
        }

        .badge {
            margin-left: auto;
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        /* コンテンツエリア */
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .content-title {
            font-size: 24px;
            color: #2c3e50;
        }

        /* カード */
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        /* テーブル */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* ボタン */
        .btn {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* フォーム */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* ステータスバッジ */
        .status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* タブ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #f8f9fa;
        }

        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
        }

        /* グリッド */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        /* サービス状況テーブル */
        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .service-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .service-card.active {
            border-color: #27ae60;
            background: #f0fff4;
        }

        .service-card.inactive {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        /* スケジュールカード */
        .schedule-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .schedule-date {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .schedule-label {
            color: #555;
            font-size: 14px;
        }

        /* レスポンシブ */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .header-stats {
                flex-wrap: wrap;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }
        /* 通知メッセージ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;
            max-width: 300px;
        }

        .notification.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* 進捗ステップUI */
        .progress-steps {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 30px 20px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            position: relative;
            flex: 0 0 auto;
        }

        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s;
            z-index: 2;
        }

        .progress-step.active .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .progress-step.completed .step-number {
            background: #27ae60;
            color: white;
        }

        .progress-step.current .step-number {
            background: #f39c12;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .step-label {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            text-align: center;
            max-width: 100px;
        }

        .progress-line {
            flex: 1;
            height: 3px;
            background: #e0e0e0;
            margin: 0 10px;
            position: relative;
        }

        .progress-line.completed {
            background: #27ae60;
        }

        /* ステップ詳細フォーム */
        .step-form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .fee-input-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .card-list-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tracking-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }

        .payment-notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .buyback-link {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <!-- ヘッダー -->
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>PSA代行サービス 総合管理システム</h1>
            <button onclick="handleLogout()" style="
                background: rgba(255,255,255,0.2);
                color: white;
                border: 1px solid rgba(255,255,255,0.3);
                padding: 8px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
            ">
                ログアウト
            </button>
        </div>
        <div class="header-stats">
            <div class="stat-item">
                <span class="stat-value" id="totalApplications">0</span>
                <span class="stat-label">総申込数</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="pendingApprovals">0</span>
                <span class="stat-label">承認待ち</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="unreadMessages">0</span>
                <span class="stat-label">未読メッセージ</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="nextShipDate">-</span>
                <span class="stat-label">次回発送日</span>
            </div>
        </div>
    </div>

    <!-- メインコンテナ -->
    <div class="main-container">
        <!-- サイドバー -->
        <div class="sidebar">
            <div class="nav-item active" onclick="showSection('dashboard')">
                <i>📊</i>
                <span>ダッシュボード</span>
            </div>
            <div class="nav-item" onclick="showSection('applications')">
                <i>📝</i>
                <span>代行申込管理</span>
                <span class="badge" id="applicationsBadge" style="display: none;">0</span>
            </div>
            <div class="nav-item" onclick="showSection('progress')">
                <i>📈</i>
                <span>進捗状況管理</span>
            </div>
            <div class="nav-item" onclick="showSection('messages')">
                <i>💬</i>
                <span>メッセージ管理</span>
                <span class="badge" id="messagesBadge" style="display: none;">0</span>
            </div>
            <div class="nav-item" onclick="showSection('approvals')">
                <i>✅</i>
                <span>買取承認管理</span>
                <span class="badge" id="approvalsBadge" style="display: none;">0</span>
            </div>
            <div class="nav-item" onclick="showSection('service')">
                <i>⚙️</i>
                <span>サービス状況設定</span>
            </div>
            <div class="nav-item" onclick="showSection('schedule')">
                <i>📅</i>
                <span>発送スケジュール</span>
            </div>
        </div>

        <!-- コンテンツエリア -->
        <div class="content">
            <!-- ダッシュボード -->
            <div id="dashboard-section" class="section">
                <div class="content-header">
                    <h2 class="content-title">ダッシュボード</h2>
                </div>

                <div class="grid">
                    <div class="card">
                        <div class="card-title">本日の申込</div>
                        <div style="font-size: 32px; font-weight: bold; color: #667eea;">
                            <span id="todayApplications">0</span>件
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">処理中</div>
                        <div style="font-size: 32px; font-weight: bold; color: #f39c12;">
                            <span id="inProgress">0</span>件
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">完了</div>
                        <div style="font-size: 32px; font-weight: bold; color: #27ae60;">
                            <span id="completed">0</span>件
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">最近の申込</div>
                    <table id="recentApplicationsTable">
                        <thead>
                            <tr>
                                <th>申込ID</th>
                                <th>顧客名</th>
                                <th>申込日時</th>
                                <th>ステータス</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="card">
                    <div class="card-title">サービス状況</div>
                    <div class="service-grid" id="serviceStatusGrid"></div>
                </div>
            </div>

            <!-- 代行申込管理 -->
            <div id="applications-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">代行申込管理</h2>
                    <button class="btn btn-primary" onclick="showApplicationForm()">新規申込追加</button>
                </div>

                <div class="card">
                    <table id="applicationsTable">
                        <thead>
                            <tr>
                                <th>申込ID</th>
                                <th>顧客名</th>
                                <th>メールアドレス</th>
                                <th>申込日時</th>
                                <th>ステータス</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- 進捗状況管理 -->
            <div id="progress-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">進捗状況管理</h2>
                    <button class="btn btn-primary" onclick="showProgressPlanForm()">新規プラン作成</button>
                </div>

                <!-- プラン選択 -->
                <div class="card">
                    <div class="card-title">代行プラン管理</div>
                    <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div class="form-group">
                            <label>日付</label>
                            <input type="date" id="progressPlanDate" onchange="filterProgressPlans()">
                        </div>
                        <div class="form-group">
                            <label>鑑定の国</label>
                            <select id="progressCountry" onchange="filterProgressPlans()">
                                <option value="">全て</option>
                                <option value="usa">🇺🇸 アメリカ</option>
                                <option value="japan">🇯🇵 日本</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>プラン</label>
                            <select id="progressPlanType" onchange="filterProgressPlans()">
                                <option value="">全て</option>
                                <option value="value-bulk">バリューバルク</option>
                                <option value="economy">エコノミー</option>
                                <option value="standard">スタンダード</option>
                                <option value="express">エクスプレス</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>顧客選択</label>
                            <select id="progressCustomerSelect" onchange="loadProgressForCustomer()">
                                <option value="">顧客を選択</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 6ステップ進捗管理 -->
                <div id="progressStepsContainer" style="display: none;">
                    <!-- ステップインジケーター -->
                    <div class="card">
                        <div class="progress-steps">
                            <div class="progress-step" id="step1" onclick="showStepDetails(1)">
                                <div class="step-number">1</div>
                                <div class="step-label">申込受付</div>
                            </div>
                            <div class="progress-line"></div>
                            <div class="progress-step" id="step2" onclick="showStepDetails(2)">
                                <div class="step-number">2</div>
                                <div class="step-label">カード受領・検品</div>
                            </div>
                            <div class="progress-line"></div>
                            <div class="progress-step" id="step3" onclick="showStepDetails(3)">
                                <div class="step-number">3</div>
                                <div class="step-label">代行料お支払い</div>
                            </div>
                            <div class="progress-line"></div>
                            <div class="progress-step" id="step4" onclick="showStepDetails(4)">
                                <div class="step-number">4</div>
                                <div class="step-label">PSA鑑定中</div>
                            </div>
                            <div class="progress-line"></div>
                            <div class="progress-step" id="step5" onclick="showStepDetails(5)">
                                <div class="step-number">5</div>
                                <div class="step-label">鑑定料お支払い</div>
                            </div>
                            <div class="progress-line"></div>
                            <div class="progress-step" id="step6" onclick="showStepDetails(6)">
                                <div class="step-number">6</div>
                                <div class="step-label">返送・完了</div>
                            </div>
                        </div>
                    </div>

                    <!-- 各ステップの詳細入力 -->
                    <div class="card" id="stepDetailsCard">
                        <div class="card-title" id="stepDetailsTitle">ステップ詳細</div>
                        <div id="stepDetailsContent"></div>
                    </div>
                </div>
            </div>

            <!-- メッセージ管理 -->
            <div id="messages-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">メッセージ管理</h2>
                    <button class="btn btn-primary" onclick="showMessageForm()">新規メッセージ</button>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="switchMessageTab('inbox')">受信箱</div>
                    <div class="tab" onclick="switchMessageTab('sent')">送信済み</div>
                </div>

                <div class="card">
                    <table id="messagesTable">
                        <thead>
                            <tr>
                                <th>日時</th>
                                <th>送信者</th>
                                <th>宛先</th>
                                <th>メッセージ</th>
                                <th>ステータス</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- 買取承認管理 -->
            <div id="approvals-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">買取承認管理</h2>
                    <button class="btn btn-primary" onclick="showApprovalForm()">新規承認申請</button>
                </div>

                <div class="card">
                    <table id="approvalsTable">
                        <thead>
                            <tr>
                                <th>承認キー</th>
                                <th>顧客名</th>
                                <th>総額</th>
                                <th>申請日時</th>
                                <th>ステータス</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- サービス状況設定 -->
            <div id="service-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">サービス状況設定</h2>
                </div>

                <div class="card">
                    <div class="card-title">サービス稼働状況</div>
                    <div class="service-grid" id="serviceManagementGrid"></div>
                </div>

                <div class="card">
                    <div class="card-title">お知らせ設定</div>
                    <div class="form-group">
                        <label>お知らせ文（利用者サイトに表示されます）</label>
                        <textarea id="serviceAnnouncement" rows="4"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="updateServiceStatus()">更新</button>
                </div>
            </div>

            <!-- 発送スケジュール -->
            <div id="schedule-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">発送スケジュール管理</h2>
                </div>

                <div class="grid">
                    <div class="schedule-card">
                        <div style="color: #2c3e50; font-size: 16px; margin-bottom: 10px;">🇺🇸 アメリカ発送</div>
                        <div class="schedule-date" id="currentNextShipDateUSA">未設定</div>
                        <div class="schedule-label">次回発送予定日</div>
                    </div>
                    <div class="schedule-card">
                        <div style="color: #2c3e50; font-size: 16px; margin-bottom: 10px;">🇯🇵 日本発送</div>
                        <div class="schedule-date" id="currentNextShipDateJapan">未設定</div>
                        <div class="schedule-label">次回発送予定日</div>
                    </div>
                </div>

                <div class="grid">
                    <div class="card">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">🇺🇸 アメリカ発送スケジュール</h3>
                        <div class="form-group">
                            <label>次回発送日</label>
                            <input type="date" id="nextShipDateUSA">
                        </div>
                        <div class="form-group">
                            <label>備考</label>
                            <textarea id="scheduleNotesUSA" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="card">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">🇯🇵 日本発送スケジュール</h3>
                        <div class="form-group">
                            <label>次回発送日</label>
                            <input type="date" id="nextShipDateJapan">
                        </div>
                        <div class="form-group">
                            <label>備考</label>
                            <textarea id="scheduleNotesJapan" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="updateSchedule()">スケジュールを更新</button>
                </div>
            </div>
        </div>
    </div>

    <!-- モーダル -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">タイトル</h3>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // グローバル変数
        let currentData = {
            applications: [],
            progress: [],
            messages: [],
            approvals: [],
            serviceStatus: {},
            schedule: {},
            statistics: {}
        };

        // 通知表示関数
        function showNotification(message, type = 'success') {
            // 既存の通知を削除
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());

            // 新しい通知を作成
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            // 3秒後に通知を削除
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', async () => {
            // 認証チェック
            if (!authAPI.isAuthenticated()) {
                showNotification('ログインが必要です', 'error');
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 1500);
                return;
            }

            // 管理者権限チェック
            try {
                const isAdmin = await authAPI.isAdmin();
                if (!isAdmin) {
                    showNotification('管理者権限が必要です', 'error');
                    setTimeout(() => {
                        await authAPI.logout();
                        window.location.href = '/login.html';
                    }, 1500);
                    return;
                }
            } catch (error) {
                console.error('権限確認エラー:', error);
                showNotification('権限の確認に失敗しました', 'error');
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 1500);
                return;
            }

            // データ読み込み
            loadStatistics();
            loadAllData();
            setInterval(loadStatistics, 30000); // 30秒ごとに統計情報を更新

            // 前回表示していたセクションを復元
            const lastSection = localStorage.getItem('currentSection') || 'dashboard';
            if (lastSection !== 'dashboard') {
                showSection(lastSection);
            }
        });

        // ログアウト処理
        async function handleLogout() {
            if (confirm('ログアウトしますか？')) {
                try {
                    await authAPI.logout();
                    showNotification('ログアウトしました', 'success');
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 1000);
                } catch (error) {
                    console.error('ログアウトエラー:', error);
                    // エラーが発生してもログアウト処理を続行
                    apiClient.removeToken();
                    window.location.href = '/login.html';
                }
            }
        }

        // データ読み込み
        async function loadAllData() {
            await Promise.all([
                loadApplications(),
                loadProgress(),
                loadMessages(),
                loadApprovals(),
                loadServiceStatus(),
                loadSchedule()
            ]);
            updateDashboard();
        }

        async function loadStatistics() {
            try {
                // APIクライアントを使用してダッシュボード統計を取得
                const dashboard = await adminAPI.getDashboard();
                currentData.statistics = {
                    totalApplications: dashboard.totalForms || 0,
                    pendingApprovals: dashboard.pendingForms || 0,
                    unreadMessages: dashboard.unreadMessages || 0,
                    inProgressApplications: dashboard.processingForms || 0,
                    completedApplications: dashboard.completedForms || 0,
                    pendingApplications: dashboard.pendingForms || 0
                };
                updateHeaderStats();

                // ダッシュボードデータも更新
                if (dashboard.recentForms) {
                    currentData.recentApplications = dashboard.recentForms;
                }
            } catch (error) {
                console.error('Failed to load statistics:', error);
                // エラーでもローカルAPIを試みる
                try {
                    const response = await fetch('/api/statistics');
                    const data = await response.json();
                    if (data.success) {
                        currentData.statistics = data.data;
                        updateHeaderStats();
                    }
                } catch (localError) {
                    console.error('Local API also failed:', localError);
                }
            }
        }

        async function loadApplications() {
            try {
                // APIクライアントを使用して申請一覧を取得
                const forms = await adminAPI.getForms();
                currentData.applications = forms;
                updateApplicationsTable();
            } catch (error) {
                console.error('Failed to load applications:', error);
                // エラーでもローカルAPIを試みる
                try {
                    const response = await fetch('/api/applications');
                    const data = await response.json();
                    if (data.success) {
                        currentData.applications = data.data;
                        updateApplicationsTable();
                    }
                } catch (localError) {
                    console.error('Local API also failed:', localError);
                }
            }
        }

        async function loadProgress() {
            try {
                const response = await fetch('/api/progress');
                const data = await response.json();
                if (data.success) {
                    currentData.progress = data.data;
                    updateProgressPlans();
                }
            } catch (error) {
                console.error('Failed to load progress:', error);
            }
        }

        // 進捗プランのフィルタリングと表示
        function updateProgressPlans() {
            const customerSelect = document.getElementById('progressCustomerSelect');
            const applications = currentData.applications;

            customerSelect.innerHTML = '<option value="">顧客を選択</option>';
            applications.forEach(app => {
                customerSelect.innerHTML += `
                    <option value="${app.id}">${app.customerName} - ${app.id.substring(0, 8)}</option>
                `;
            });
        }

        function filterProgressPlans() {
            const date = document.getElementById('progressPlanDate').value;
            const country = document.getElementById('progressCountry').value;
            const planType = document.getElementById('progressPlanType').value;

            // フィルタリング処理
            updateProgressPlans();
        }

        async function loadProgressForCustomer() {
            const applicationId = document.getElementById('progressCustomerSelect').value;
            if (!applicationId) {
                document.getElementById('progressStepsContainer').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/api/progress/${applicationId}`);
                const data = await response.json();
                if (data.success) {
                    currentData.currentProgress = data.data;
                    displayProgressSteps(data.data);
                    document.getElementById('progressStepsContainer').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load progress:', error);
            }
        }

        function displayProgressSteps(progress) {
            if (!progress || !progress.steps) return;

            // 各ステップの状態を更新
            for (let i = 1; i <= 6; i++) {
                const step = document.getElementById(`step${i}`);
                const stepData = progress.steps[`step${i}`];

                if (stepData) {
                    step.className = 'progress-step';
                    if (stepData.status === 'completed') {
                        step.classList.add('completed');
                    } else if (stepData.status === 'current') {
                        step.classList.add('current');
                    } else if (stepData.status === 'active') {
                        step.classList.add('active');
                    }
                }
            }

            // 進捗ラインの更新
            const lines = document.querySelectorAll('.progress-line');
            for (let i = 0; i < lines.length; i++) {
                const stepData = progress.steps[`step${i + 1}`];
                if (stepData && stepData.status === 'completed') {
                    lines[i].classList.add('completed');
                } else {
                    lines[i].classList.remove('completed');
                }
            }
        }

        let currentStepNumber = 1;
        function showStepDetails(stepNumber) {
            currentStepNumber = stepNumber;
            const stepDetailsContent = document.getElementById('stepDetailsContent');
            const stepDetailsTitle = document.getElementById('stepDetailsTitle');

            const stepTitles = {
                1: '1. 申込受付',
                2: '2. カード受領・検品',
                3: '3. 代行料のお支払い',
                4: '4. PSA鑑定中',
                5: '5. 鑑定料お支払い',
                6: '6. 返送・完了'
            };

            stepDetailsTitle.textContent = stepTitles[stepNumber];

            const progress = currentData.currentProgress;
            const stepData = progress?.steps[`step${stepNumber}`] || {};

            switch (stepNumber) {
                case 1:
                    stepDetailsContent.innerHTML = `
                        <p>申込受付は完了しています。</p>
                        <div class="form-group">
                            <label>受付日時</label>
                            <input type="datetime-local" value="${stepData.date || ''}" readonly class="form-control">
                        </div>
                        <div class="form-group">
                            <label>備考</label>
                            <textarea class="form-control" readonly>${stepData.notes || '申込受付完了'}</textarea>
                        </div>
                    `;
                    break;

                case 2:
                    stepDetailsContent.innerHTML = `
                        <p>カード受領・検品について</p>
                        <div class="form-group">
                            <label>ステータス</label>
                            <select id="step2Status" class="form-control">
                                <option value="pending">未受領</option>
                                <option value="completed">受領完了</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>受領日</label>
                            <input type="date" id="step2Date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>備考</label>
                            <textarea id="step2Notes" class="form-control"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="updateStep(2)">更新</button>
                    `;
                    break;

                case 3:
                    stepDetailsContent.innerHTML = `
                        <div class="payment-notice">
                            <h4>代行料のお支払い待ち</h4>
                            <p>Shopifyから決済メールを送るのでお待ちください。</p>
                        </div>
                        <div class="form-group">
                            <label>支払いステータス</label>
                            <select id="step3Status" class="form-control">
                                <option value="pending">支払い待ち</option>
                                <option value="completed">支払い完了</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Shopify決済リンク</label>
                            <input type="text" id="step3PaymentLink" class="form-control" placeholder="https://...">
                        </div>
                        <button class="btn btn-primary" onclick="updateStep(3)">更新</button>
                        <button class="btn btn-warning" onclick="sendPaymentReminder(3)">決済リマインダー送信</button>
                    `;
                    break;

                case 4:
                    stepDetailsContent.innerHTML = `
                        <h4>PSA鑑定中 - カード情報管理</h4>
                        <div id="cardListContainer">
                            ${(stepData.cards || []).map((card, index) => `
                                <div class="card-list-item">
                                    <div>
                                        <strong>${card.name}</strong>
                                        <span class="text-muted"> - ${card.quantity}枚</span>
                                    </div>
                                    <button class="btn btn-sm btn-danger" onclick="removeCard(${index})">削除</button>
                                </div>
                            `).join('')}
                        </div>
                        <div class="step-form-grid">
                            <div class="form-group">
                                <label>カード名</label>
                                <input type="text" id="cardName" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>枚数</label>
                                <input type="number" id="cardQuantity" class="form-control" value="1">
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="addCard()">カード追加</button>
                        <button class="btn btn-primary" onclick="updateStep(4)">更新</button>
                    `;
                    break;

                case 5:
                    stepDetailsContent.innerHTML = `
                        <h4>鑑定料お支払い設定</h4>
                        <div class="fee-input-group">
                            <div class="form-group">
                                <label>鑑定料</label>
                                <input type="number" id="gradingFee" class="form-control" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>輸出入送料</label>
                                <input type="number" id="shippingFee" class="form-control" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>追加代行料</label>
                                <input type="number" id="additionalFee" class="form-control" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>その他費用</label>
                                <input type="number" id="otherFee" class="form-control" placeholder="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>合計金額</label>
                            <input type="number" id="totalFee" class="form-control" readonly>
                        </div>
                        <div class="buyback-link" onclick="showBuybackOption()">
                            🛒 買取希望者向けページへの案内を追加
                        </div>
                        <button class="btn btn-primary" onclick="updateStep(5)">更新</button>
                        <button class="btn btn-warning" onclick="sendPaymentRequest(5)">支払い請求送信</button>
                    `;

                    // 合計金額の自動計算
                    ['gradingFee', 'shippingFee', 'additionalFee', 'otherFee'].forEach(id => {
                        document.getElementById(id).addEventListener('input', calculateTotalFee);
                    });
                    break;

                case 6:
                    stepDetailsContent.innerHTML = `
                        <h4>返送・完了管理</h4>
                        <div id="trackingNumbersContainer">
                            ${Object.entries(stepData.trackingNumbers || {}).map(([customer, tracking]) => `
                                <div class="tracking-input">
                                    <label>${customer}</label>
                                    <input type="text" value="${tracking}" class="form-control" data-customer="${customer}">
                                </div>
                            `).join('')}
                        </div>
                        <div class="form-group">
                            <label>新規追跡番号</label>
                            <div class="step-form-grid">
                                <input type="text" id="trackingCustomer" class="form-control" placeholder="顧客名">
                                <input type="text" id="trackingNumber" class="form-control" placeholder="追跡番号">
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="addTrackingNumber()">追跡番号追加</button>
                        <button class="btn btn-primary" onclick="updateStep(6)">更新</button>
                        <button class="btn btn-info" onclick="sendShippingNotification(6)">発送通知送信</button>
                    `;
                    break;
            }
        }

        async function loadMessages() {
            try {
                const response = await fetch('/api/messages');
                const data = await response.json();
                if (data.success) {
                    currentData.messages = data.data;
                    updateMessagesTable();
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }

        async function loadApprovals() {
            try {
                const response = await fetch('/api/approvals');
                const data = await response.json();
                if (data.success) {
                    currentData.approvals = data.data;
                    updateApprovalsTable();
                }
            } catch (error) {
                console.error('Failed to load approvals:', error);
            }
        }

        async function loadServiceStatus() {
            try {
                const response = await fetch('/api/service-status');
                const data = await response.json();
                if (data.success) {
                    currentData.serviceStatus = data.data;
                    updateServiceStatusDisplay();
                }
            } catch (error) {
                console.error('Failed to load service status:', error);
            }
        }

        async function loadSchedule() {
            try {
                const response = await fetch('/api/schedule');
                const data = await response.json();
                if (data.success) {
                    currentData.schedule = data.data;
                    updateScheduleDisplay();
                }
            } catch (error) {
                console.error('Failed to load schedule:', error);
            }
        }

        // UI更新関数
        function updateHeaderStats() {
            const stats = currentData.statistics;
            document.getElementById('totalApplications').textContent = stats.totalApplications || 0;
            document.getElementById('pendingApprovals').textContent = stats.pendingApprovals || 0;
            document.getElementById('unreadMessages').textContent = stats.unreadMessages || 0;

            // アメリカと日本の次回発送日を表示（最も近い日付を表示）
            let nextDate = null;
            if (stats.nextShipDateUSA && stats.nextShipDateJapan) {
                const usaDate = new Date(stats.nextShipDateUSA);
                const japanDate = new Date(stats.nextShipDateJapan);
                nextDate = usaDate < japanDate ? usaDate : japanDate;
            } else if (stats.nextShipDateUSA) {
                nextDate = new Date(stats.nextShipDateUSA);
            } else if (stats.nextShipDateJapan) {
                nextDate = new Date(stats.nextShipDateJapan);
            }

            document.getElementById('nextShipDate').textContent =
                nextDate ? nextDate.toLocaleDateString('ja-JP') : '-';

            // バッジ更新
            updateBadge('applicationsBadge', stats.pendingApplications);
            updateBadge('messagesBadge', stats.unreadMessages);
            updateBadge('approvalsBadge', stats.pendingApprovals);
        }

        function updateBadge(elementId, count) {
            const badge = document.getElementById(elementId);
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function updateDashboard() {
            const stats = currentData.statistics;
            document.getElementById('todayApplications').textContent =
                currentData.applications.filter(a => {
                    const today = new Date().toDateString();
                    return new Date(a.createdAt).toDateString() === today;
                }).length;

            document.getElementById('inProgress').textContent = stats.inProgressApplications || 0;
            document.getElementById('completed').textContent = stats.completedApplications || 0;

            // 最近の申込
            const recentApplications = currentData.applications.slice(0, 5);
            const tbody = document.querySelector('#recentApplicationsTable tbody');
            tbody.innerHTML = recentApplications.map(app => `
                <tr>
                    <td>${app.id.substring(0, 8)}</td>
                    <td>${app.customerName || '-'}</td>
                    <td>${new Date(app.createdAt).toLocaleString('ja-JP')}</td>
                    <td><span class="status status-${app.status}">${getStatusLabel(app.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewApplication('${app.id}')">詳細</button>
                    </td>
                </tr>
            `).join('');

            // サービス状況
            if (currentData.serviceStatus.services) {
                document.getElementById('serviceStatusGrid').innerHTML =
                    currentData.serviceStatus.services.map(service => `
                        <div class="service-card ${service.status}">
                            <div style="font-size: 18px; font-weight: bold;">${service.name}</div>
                            <div style="margin-top: 5px; color: ${service.status === 'active' ? '#27ae60' : '#e74c3c'};">
                                ${service.status === 'active' ? '稼働中' : '停止中'}
                            </div>
                        </div>
                    `).join('');
            }
        }

        function updateApplicationsTable() {
            const tbody = document.querySelector('#applicationsTable tbody');
            tbody.innerHTML = currentData.applications.map(app => `
                <tr>
                    <td>${app.id.substring(0, 8)}</td>
                    <td>${app.customerName || '-'}</td>
                    <td>${app.customerEmail || '-'}</td>
                    <td>${new Date(app.createdAt).toLocaleString('ja-JP')}</td>
                    <td><span class="status status-${app.status}">${getStatusLabel(app.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewApplication('${app.id}')">詳細</button>
                        <button class="btn btn-sm btn-success" onclick="updateApplicationStatus('${app.id}')">更新</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteApplication('${app.id}')">削除</button>
                    </td>
                </tr>
            `).join('');

            // 進捗管理用のセレクトボックスも更新
            const select = document.getElementById('progressApplicationSelect');
            if (select) {
                select.innerHTML = '<option value="">申込を選択してください</option>' +
                    currentData.applications.map(app =>
                        `<option value="${app.id}">${app.customerName} - ${app.id.substring(0, 8)}</option>`
                    ).join('');
            }
        }

        function updateMessagesTable() {
            const tbody = document.querySelector('#messagesTable tbody');
            tbody.innerHTML = currentData.messages.map(msg => `
                <tr>
                    <td>${new Date(msg.createdAt).toLocaleString('ja-JP')}</td>
                    <td>${msg.from}</td>
                    <td>${msg.to}</td>
                    <td>${msg.message.substring(0, 50)}${msg.message.length > 50 ? '...' : ''}</td>
                    <td>${msg.read ? '既読' : '<strong>未読</strong>'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewMessage('${msg.id}')">詳細</button>
                        ${!msg.read ? `<button class="btn btn-sm btn-success" onclick="markAsRead('${msg.id}')">既読</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function updateApprovalsTable() {
            const tbody = document.querySelector('#approvalsTable tbody');
            tbody.innerHTML = currentData.approvals.map(approval => `
                <tr>
                    <td>${approval.approvalKey}</td>
                    <td>${approval.customerName}</td>
                    <td>¥${(approval.totalPrice || 0).toLocaleString()}</td>
                    <td>${new Date(approval.createdAt).toLocaleString('ja-JP')}</td>
                    <td><span class="status status-${approval.status}">${getStatusLabel(approval.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewApproval('${approval.id}')">詳細</button>
                        <button class="btn btn-sm btn-warning" onclick="resendApprovalEmail('${approval.id}')">再送信</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateServiceStatus() {
            if (currentData.serviceStatus.services) {
                document.getElementById('serviceManagementGrid').innerHTML =
                    currentData.serviceStatus.services.map(service => `
                        <div class="service-card ${service.status}" onclick="toggleService('${service.id}')">
                            <div style="font-size: 18px; font-weight: bold;">${service.name}</div>
                            <div style="margin-top: 5px;">
                                ${service.status === 'active' ? '✅ 稼働中' : '❌ 停止中'}
                            </div>
                            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                クリックで切り替え
                            </div>
                        </div>
                    `).join('');

                document.getElementById('serviceAnnouncement').value =
                    currentData.serviceStatus.announcement || '';
            }
        }

        function updateScheduleDisplay() {
            // アメリカの発送スケジュール
            if (currentData.schedule.usa?.nextShipDate) {
                document.getElementById('currentNextShipDateUSA').textContent =
                    new Date(currentData.schedule.usa.nextShipDate).toLocaleDateString('ja-JP');
                document.getElementById('nextShipDateUSA').value =
                    currentData.schedule.usa.nextShipDate.split('T')[0];
            } else {
                document.getElementById('currentNextShipDateUSA').textContent = '未設定';
            }
            if (currentData.schedule.usa?.notes) {
                document.getElementById('scheduleNotesUSA').value = currentData.schedule.usa.notes;
            }

            // 日本の発送スケジュール
            if (currentData.schedule.japan?.nextShipDate) {
                document.getElementById('currentNextShipDateJapan').textContent =
                    new Date(currentData.schedule.japan.nextShipDate).toLocaleDateString('ja-JP');
                document.getElementById('nextShipDateJapan').value =
                    currentData.schedule.japan.nextShipDate.split('T')[0];
            } else {
                document.getElementById('currentNextShipDateJapan').textContent = '未設定';
            }
            if (currentData.schedule.japan?.notes) {
                document.getElementById('scheduleNotesJapan').value = currentData.schedule.japan.notes;
            }
        }

        // セクション表示切り替え
        function showSection(sectionName) {
            // すべてのセクションを非表示
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });

            // 選択されたセクションを表示
            document.getElementById(`${sectionName}-section`).style.display = 'block';

            // ナビゲーションのアクティブ状態を更新
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');

            // 現在のセクションをlocalStorageに保存
            localStorage.setItem('currentSection', sectionName);

            // データを更新
            if (sectionName === 'dashboard') {
                updateDashboard();
            }
        }

        // ステータスラベル取得
        function getStatusLabel(status) {
            const labels = {
                'pending': '保留中',
                'in_progress': '処理中',
                'completed': '完了',
                'approved': '承認済み',
                'rejected': '拒否',
                'active': '稼働中',
                'inactive': '停止中'
            };
            return labels[status] || status;
        }

        // モーダル表示
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // API呼び出し関数
        async function updateSchedule() {
            const scheduleData = {
                usa: {
                    nextShipDate: document.getElementById('nextShipDateUSA').value,
                    notes: document.getElementById('scheduleNotesUSA').value
                },
                japan: {
                    nextShipDate: document.getElementById('nextShipDateJapan').value,
                    notes: document.getElementById('scheduleNotesJapan').value
                }
            };

            try {
                const response = await fetch('/api/schedule', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(scheduleData)
                });

                const data = await response.json();
                if (data.success) {
                    showNotification('スケジュールを更新しました', 'success');
                    loadSchedule();
                    loadStatistics();
                }
            } catch (error) {
                showNotification('エラーが発生しました', 'error');
            }
        }

        async function toggleService(serviceId) {
            const service = currentData.serviceStatus.services.find(s => s.id === serviceId);
            if (service) {
                service.status = service.status === 'active' ? 'inactive' : 'active';

                try {
                    const response = await fetch('/api/service-status', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(currentData.serviceStatus)
                    });

                    const data = await response.json();
                    if (data.success) {
                        loadServiceStatus();
                    }
                } catch (error) {
                    showNotification('エラーが発生しました', 'error');
                }
            }
        }

        async function updateServiceStatus() {
            currentData.serviceStatus.announcement = document.getElementById('serviceAnnouncement').value;

            try {
                const response = await fetch('/api/service-status', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentData.serviceStatus)
                });

                const data = await response.json();
                if (data.success) {
                    showNotification('サービス状況を更新しました', 'success');
                    loadServiceStatus();
                }
            } catch (error) {
                showNotification('エラーが発生しました', 'error');
            }
        }

        // ステップ更新関数
        async function updateStep(stepNumber) {
            const applicationId = document.getElementById('progressCustomerSelect').value;
            if (!applicationId) {
                showNotification('顧客を選択してください', 'warning');
                return;
            }

            const stepData = {};
            switch (stepNumber) {
                case 2:
                    stepData.status = document.getElementById('step2Status').value;
                    stepData.date = document.getElementById('step2Date').value;
                    stepData.notes = document.getElementById('step2Notes').value;
                    break;
                case 3:
                    stepData.status = document.getElementById('step3Status').value;
                    stepData.paymentLink = document.getElementById('step3PaymentLink').value;
                    break;
                case 4:
                    const progress = currentData.currentProgress;
                    stepData.cards = progress.steps.step4.cards || [];
                    stepData.status = 'current';
                    break;
                case 5:
                    stepData.fees = {
                        grading: parseFloat(document.getElementById('gradingFee').value) || 0,
                        shipping: parseFloat(document.getElementById('shippingFee').value) || 0,
                        additional: parseFloat(document.getElementById('additionalFee').value) || 0,
                        other: parseFloat(document.getElementById('otherFee').value) || 0
                    };
                    stepData.status = 'current';
                    break;
                case 6:
                    const trackingNumbers = {};
                    document.querySelectorAll('#trackingNumbersContainer input').forEach(input => {
                        if (input.dataset.customer) {
                            trackingNumbers[input.dataset.customer] = input.value;
                        }
                    });
                    stepData.trackingNumbers = trackingNumbers;
                    stepData.status = 'current';
                    break;
            }

            try {
                const response = await fetch(`/api/progress/${applicationId}/step/step${stepNumber}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(stepData)
                });

                const data = await response.json();
                if (data.success) {
                    showNotification(`ステップ${stepNumber}を更新しました`, 'success');
                    loadProgressForCustomer();
                }
            } catch (error) {
                showNotification('更新に失敗しました', 'error');
            }
        }

        // カード管理関数
        function addCard() {
            const cardName = document.getElementById('cardName').value;
            const cardQuantity = parseInt(document.getElementById('cardQuantity').value) || 1;

            if (!cardName) {
                showNotification('カード名を入力してください', 'warning');
                return;
            }

            const progress = currentData.currentProgress;
            if (!progress.steps.step4.cards) {
                progress.steps.step4.cards = [];
            }

            progress.steps.step4.cards.push({ name: cardName, quantity: cardQuantity });

            document.getElementById('cardName').value = '';
            document.getElementById('cardQuantity').value = '1';

            showStepDetails(4);
            updateStep(4);
        }

        function removeCard(index) {
            const progress = currentData.currentProgress;
            progress.steps.step4.cards.splice(index, 1);
            showStepDetails(4);
            updateStep(4);
        }

        // 合計金額計算
        function calculateTotalFee() {
            const grading = parseFloat(document.getElementById('gradingFee').value) || 0;
            const shipping = parseFloat(document.getElementById('shippingFee').value) || 0;
            const additional = parseFloat(document.getElementById('additionalFee').value) || 0;
            const other = parseFloat(document.getElementById('otherFee').value) || 0;

            const total = grading + shipping + additional + other;
            document.getElementById('totalFee').value = total;
        }

        // 追跡番号管理
        function addTrackingNumber() {
            const customer = document.getElementById('trackingCustomer').value;
            const tracking = document.getElementById('trackingNumber').value;

            if (!customer || !tracking) {
                showNotification('顧客名と追跡番号を入力してください', 'warning');
                return;
            }

            const container = document.getElementById('trackingNumbersContainer');
            const newInput = document.createElement('div');
            newInput.className = 'tracking-input';
            newInput.innerHTML = `
                <label>${customer}</label>
                <input type="text" value="${tracking}" class="form-control" data-customer="${customer}">
            `;
            container.appendChild(newInput);

            document.getElementById('trackingCustomer').value = '';
            document.getElementById('trackingNumber').value = '';
        }

        // 支払いリマインダー送信
        async function sendPaymentReminder(stepNumber) {
            const applicationId = document.getElementById('progressCustomerSelect').value;
            if (!applicationId) {
                showNotification('顧客を選択してください', 'warning');
                return;
            }

            showNotification('決済リマインダーを送信しました', 'success');
        }

        // 支払い請求送信
        async function sendPaymentRequest(stepNumber) {
            const applicationId = document.getElementById('progressCustomerSelect').value;
            if (!applicationId) {
                showNotification('顧客を選択してください', 'warning');
                return;
            }

            showNotification('支払い請求を送信しました', 'success');
        }

        // 発送通知送信
        async function sendShippingNotification(stepNumber) {
            const applicationId = document.getElementById('progressCustomerSelect').value;
            if (!applicationId) {
                showNotification('顧客を選択してください', 'warning');
                return;
            }

            showNotification('発送通知を送信しました', 'success');
        }

        // 買取オプション表示
        function showBuybackOption() {
            showModal('買取希望者向け案内', `
                <div class="buyback-info">
                    <h4>買取希望者向けページへの導線</h4>
                    <p>このお客様に買取オプションをご案内します。</p>
                    <div class="form-group">
                        <label>買取承認URL</label>
                        <input type="text" id="buybackUrl" class="form-control" value="https://kanucard-daiko-support.onrender.com/buyback" readonly>
                    </div>
                    <div class="form-group">
                        <label>メッセージ</label>
                        <textarea id="buybackMessage" class="form-control" rows="4">PSA鑑定後のカードの買取をご希望の場合は、以下のリンクからお申し込みください。</textarea>
                    </div>
                    <button class="btn btn-primary" onclick="sendBuybackInvitation()">案内メール送信</button>
                    <button class="btn" onclick="closeModal()">キャンセル</button>
                </div>
            `);
        }

        async function sendBuybackInvitation() {
            const applicationId = document.getElementById('progressCustomerSelect').value;
            const message = document.getElementById('buybackMessage').value;

            showNotification('買取案内を送信しました', 'success');
            closeModal();
        }

        // 新規プラン作成フォーム
        function showProgressPlanForm() {
            showModal('新規代行プラン作成', `
                <div class="form-group">
                    <label>日付</label>
                    <input type="date" id="newPlanDate" class="form-control">
                </div>
                <div class="form-group">
                    <label>鑑定の国</label>
                    <select id="newPlanCountry" class="form-control">
                        <option value="usa">🇺🇸 アメリカ</option>
                        <option value="japan">🇯🇵 日本</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>プランタイプ</label>
                    <select id="newPlanType" class="form-control">
                        <option value="value-bulk">バリューバルク</option>
                        <option value="economy">エコノミー</option>
                        <option value="standard">スタンダード</option>
                        <option value="express">エクスプレス</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>対象顧客</label>
                    <select id="newPlanCustomers" class="form-control" multiple size="5">
                        ${currentData.applications.map(app =>
                            `<option value="${app.id}">${app.customerName}</option>`
                        ).join('')}
                    </select>
                    <small>複数選択可（Ctrlキーを押しながらクリック）</small>
                </div>
                <button class="btn btn-primary" onclick="createProgressPlan()">作成</button>
                <button class="btn" onclick="closeModal()">キャンセル</button>
            `);
        }

        async function createProgressPlan() {
            const planDate = document.getElementById('newPlanDate').value;
            const country = document.getElementById('newPlanCountry').value;
            const planType = document.getElementById('newPlanType').value;
            const selectedOptions = document.getElementById('newPlanCustomers').selectedOptions;
            const customers = Array.from(selectedOptions).map(opt => opt.value);

            if (!planDate || customers.length === 0) {
                showNotification('日付と顧客を選択してください', 'warning');
                return;
            }

            // 各顧客に対して進捗を作成
            for (const customerId of customers) {
                try {
                    const response = await fetch('/api/progress', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            applicationId: customerId,
                            planDate: planDate,
                            country: country,
                            planType: planType,
                            customers: customers
                        })
                    });

                    const data = await response.json();
                    if (!data.success) {
                        console.error('Failed to create progress for', customerId);
                    }
                } catch (error) {
                    console.error('Error creating progress:', error);
                }
            }

            showNotification('代行プランを作成しました', 'success');
            closeModal();
            loadProgress();
        }


        // モーダルフォーム表示関数
        function showApplicationForm() {
            showModal('新規申込追加', `
                <div class="form-group">
                    <label>顧客名</label>
                    <input type="text" id="newAppCustomerName">
                </div>
                <div class="form-group">
                    <label>メールアドレス</label>
                    <input type="email" id="newAppCustomerEmail">
                </div>
                <div class="form-group">
                    <label>申込内容</label>
                    <textarea id="newAppContent" rows="4"></textarea>
                </div>
                <button class="btn btn-primary" onclick="createApplication()">作成</button>
                <button class="btn" onclick="closeModal()">キャンセル</button>
            `);
        }

        function showMessageForm() {
            showModal('新規メッセージ', `
                <div class="form-group">
                    <label>宛先</label>
                    <select id="newMessageTo">
                        ${currentData.applications.map(app =>
                            `<option value="${app.id}">${app.customerName} - ${app.customerEmail}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>メッセージ</label>
                    <textarea id="newMessageContent" rows="6"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="newMessageSendEmail"> メールで送信
                    </label>
                </div>
                <button class="btn btn-primary" onclick="sendMessage()">送信</button>
                <button class="btn" onclick="closeModal()">キャンセル</button>
            `);
        }

        function showApprovalForm() {
            showModal('新規承認申請', `
                <div class="form-group">
                    <label>顧客名</label>
                    <input type="text" id="newApprovalCustomerName">
                </div>
                <div class="form-group">
                    <label>メールアドレス</label>
                    <input type="email" id="newApprovalCustomerEmail">
                </div>
                <div class="form-group">
                    <label>カード名</label>
                    <input type="text" id="newApprovalCardName">
                </div>
                <div class="form-group">
                    <label>買取価格</label>
                    <input type="number" id="newApprovalPrice">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="newApprovalSendEmail" checked> メールで送信
                    </label>
                </div>
                <button class="btn btn-primary" onclick="createApproval()">作成</button>
                <button class="btn" onclick="closeModal()">キャンセル</button>
            `);
        }

        // API作成関数
        async function createApplication() {
            const applicationData = {
                customerName: document.getElementById('newAppCustomerName').value,
                customerEmail: document.getElementById('newAppCustomerEmail').value,
                content: document.getElementById('newAppContent').value
            };

            try {
                const response = await fetch('/api/applications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(applicationData)
                });

                const data = await response.json();
                if (data.success) {
                    closeModal();
                    loadApplications();
                    loadStatistics();
                }
            } catch (error) {
                showNotification('エラーが発生しました', 'error');
            }
        }

        async function sendMessage() {
            const messageData = {
                to: document.getElementById('newMessageTo').value,
                message: document.getElementById('newMessageContent').value,
                sendEmail: document.getElementById('newMessageSendEmail').checked,
                toEmail: currentData.applications.find(a => a.id === document.getElementById('newMessageTo').value)?.customerEmail
            };

            try {
                const response = await fetch('/api/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(messageData)
                });

                const data = await response.json();
                if (data.success) {
                    closeModal();
                    loadMessages();
                }
            } catch (error) {
                alert('エラーが発生しました');
            }
        }

        async function createApproval() {
            const approvalData = {
                customerName: document.getElementById('newApprovalCustomerName').value,
                customerEmail: document.getElementById('newApprovalCustomerEmail').value,
                cards: [{
                    name: document.getElementById('newApprovalCardName').value,
                    price: parseFloat(document.getElementById('newApprovalPrice').value)
                }],
                totalPrice: parseFloat(document.getElementById('newApprovalPrice').value),
                sendEmail: document.getElementById('newApprovalSendEmail').checked
            };

            try {
                const response = await fetch('/api/approvals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(approvalData)
                });

                const data = await response.json();
                if (data.success) {
                    closeModal();
                    loadApprovals();
                    loadStatistics();
                }
            } catch (error) {
                showNotification('エラーが発生しました', 'error');
            }
        }

        // その他のユーティリティ関数
        async function markAsRead(messageId) {
            try {
                const response = await fetch(`/api/messages/${messageId}/read`, {
                    method: 'PUT'
                });

                const data = await response.json();
                if (data.success) {
                    loadMessages();
                    loadStatistics();
                }
            } catch (error) {
                showNotification('エラーが発生しました', 'error');
            }
        }

        function viewApplication(id) {
            const app = currentData.applications.find(a => a.id === id);
            if (app) {
                showModal('申込詳細', `
                    <div class="form-group">
                        <label>申込ID</label>
                        <div>${app.id}</div>
                    </div>
                    <div class="form-group">
                        <label>顧客名</label>
                        <div>${app.customerName}</div>
                    </div>
                    <div class="form-group">
                        <label>メールアドレス</label>
                        <div>${app.customerEmail}</div>
                    </div>
                    <div class="form-group">
                        <label>申込日時</label>
                        <div>${new Date(app.createdAt).toLocaleString('ja-JP')}</div>
                    </div>
                    <div class="form-group">
                        <label>ステータス</label>
                        <div><span class="status status-${app.status}">${getStatusLabel(app.status)}</span></div>
                    </div>
                    <button class="btn" onclick="closeModal()">閉じる</button>
                `);
            }
        }

        function viewMessage(id) {
            const msg = currentData.messages.find(m => m.id === id);
            if (msg) {
                showModal('メッセージ詳細', `
                    <div class="form-group">
                        <label>送信日時</label>
                        <div>${new Date(msg.createdAt).toLocaleString('ja-JP')}</div>
                    </div>
                    <div class="form-group">
                        <label>送信者</label>
                        <div>${msg.from}</div>
                    </div>
                    <div class="form-group">
                        <label>宛先</label>
                        <div>${msg.to}</div>
                    </div>
                    <div class="form-group">
                        <label>メッセージ</label>
                        <div style="white-space: pre-wrap;">${msg.message}</div>
                    </div>
                    <button class="btn" onclick="closeModal()">閉じる</button>
                `);
                if (!msg.read) {
                    markAsRead(id);
                }
            }
        }

        function viewApproval(id) {
            const approval = currentData.approvals.find(a => a.id === id);
            if (approval) {
                showModal('承認詳細', `
                    <div class="form-group">
                        <label>承認キー</label>
                        <div style="font-family: monospace; font-size: 18px;">${approval.approvalKey}</div>
                    </div>
                    <div class="form-group">
                        <label>顧客名</label>
                        <div>${approval.customerName}</div>
                    </div>
                    <div class="form-group">
                        <label>メールアドレス</label>
                        <div>${approval.customerEmail}</div>
                    </div>
                    <div class="form-group">
                        <label>総額</label>
                        <div>¥${(approval.totalPrice || 0).toLocaleString()}</div>
                    </div>
                    <div class="form-group">
                        <label>申請日時</label>
                        <div>${new Date(approval.createdAt).toLocaleString('ja-JP')}</div>
                    </div>
                    <div class="form-group">
                        <label>ステータス</label>
                        <div><span class="status status-${approval.status}">${getStatusLabel(approval.status)}</span></div>
                    </div>
                    <div class="form-group">
                        <label>承認URL</label>
                        <div style="word-break: break-all;">
                            <a href="https://kanucard-daiko-support.onrender.com/approval/${approval.approvalKey}" target="_blank">
                                https://kanucard-daiko-support.onrender.com/approval/${approval.approvalKey}
                            </a>
                        </div>
                    </div>
                    <button class="btn" onclick="closeModal()">閉じる</button>
                `);
            }
        }

        async function deleteApplication(id) {
            if (!confirm('本当に削除しますか？')) return;

            try {
                const response = await fetch(`/api/applications/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    loadApplications();
                    loadStatistics();
                }
            } catch (error) {
                showNotification('エラーが発生しました', 'error');
            }
        }

        // 画面外クリックでモーダルを閉じる
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>