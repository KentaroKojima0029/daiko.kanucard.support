<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSAä»£è¡Œã‚µãƒ¼ãƒ“ã‚¹ ç·åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>

    <!-- APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèª­ã¿è¾¼ã¿ -->
    <script src="/js/api-config.js"></script>
    <script src="/js/api-client.js"></script>
    <script src="/js/api-auth.js"></script>
    <script src="/js/api-admin.js"></script>
    <script src="/js/api-forms.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header-stats {
            display: flex;
            gap: 30px;
            margin-top: 15px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .main-container {
            display: flex;
            height: calc(100vh - 120px);
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .nav-item:hover {
            background: #f8f9fa;
        }

        .nav-item.active {
            background: #f0f4ff;
            border-left-color: #667eea;
        }

        .nav-item i {
            width: 20px;
            margin-right: 10px;
        }

        .badge {
            margin-left: auto;
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .content-title {
            font-size: 24px;
            color: #2c3e50;
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
        .status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« - Shopifyãƒœã‚¿ãƒ³ç”¨ã«è¿½åŠ  */
        .btn-info {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 2px;
            transition: background 0.3s ease;
        }

        .btn-info:hover {
            background: #138496;
        }

        /* ã‚¿ãƒ– */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #f8f9fa;
        }

        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
        }

        /* ã‚°ãƒªãƒƒãƒ‰ */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        /* ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ« */
        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .service-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .service-card.active {
            border-color: #27ae60;
            background: #f0fff4;
        }

        .service-card.inactive {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        /* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ */
        .schedule-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .schedule-date {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .schedule-label {
            color: #555;
            font-size: 14px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .header-stats {
                flex-wrap: wrap;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }
        /* é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;
            max-width: 300px;
        }

        .notification.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* é€²æ—ã‚¹ãƒ†ãƒƒãƒ—UI */
        .progress-steps {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 30px 20px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            position: relative;
            flex: 0 0 auto;
        }

        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s;
            z-index: 2;
        }

        .progress-step.active .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .progress-step.completed .step-number {
            background: #27ae60;
            color: white;
        }

        .progress-step.current .step-number {
            background: #f39c12;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .step-label {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            text-align: center;
            max-width: 100px;
        }

        .progress-line {
            flex: 1;
            height: 3px;
            background: #e0e0e0;
            margin: 0 10px;
            position: relative;
        }

        .progress-line.completed {
            background: #27ae60;
        }

        /* ã‚¹ãƒ†ãƒƒãƒ—è©³ç´°ãƒ•ã‚©ãƒ¼ãƒ  */
        .step-form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .fee-input-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .card-list-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tracking-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }

        .payment-notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .buyback-link {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            margin: 15px 0;
        }
        /* Shopifyé¡§å®¢ç®¡ç†ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .stat-card .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: none;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®èª¿æ•´ */
        #shopifyCustomersTable {
            margin-top: 0;
        }

        #shopifyCustomersTable thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        #shopifyCustomersTable thead th {
            color: white;
            font-weight: 600;
            padding: 1rem;
        }

        #shopifyCustomersTable tbody tr:hover {
            background: #f7fafc;
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>PSAä»£è¡Œã‚µãƒ¼ãƒ“ã‚¹ ç·åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <button onclick="handleLogout()" style="
                background: rgba(255,255,255,0.2);
                color: white;
                border: 1px solid rgba(255,255,255,0.3);
                padding: 8px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
            ">
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
        </div>
        <div class="header-stats">
            <div class="stat-item">
                <span class="stat-value" id="totalApplications">0</span>
                <span class="stat-label">ç·ç”³è¾¼æ•°</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="pendingApprovals">0</span>
                <span class="stat-label">æ‰¿èªå¾…ã¡</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="unreadMessages">0</span>
                <span class="stat-label">æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="nextShipDate">-</span>
                <span class="stat-label">æ¬¡å›ç™ºé€æ—¥</span>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="main-container">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="sidebar">
            <div class="nav-item active" onclick="showSection('dashboard', event)">
                <i>ğŸ“Š</i>
                <span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
            </div>
            <div class="nav-item" onclick="showSection('applications', event)">
                <i>ğŸ“</i>
                <span>ä»£è¡Œç”³è¾¼ç®¡ç†</span>
                <span class="badge" id="applicationsBadge" style="display: none;">0</span>
            </div>
            <div class="nav-item" onclick="showSection('customers', event)">
                <i>ğŸ‘¥</i>
                <span>Shopifyé¡§å®¢ç®¡ç†</span>
            </div>
            <div class="nav-item" onclick="showSection('progress', event)">
                <i>ğŸ“ˆ</i>
                <span>é€²æ—çŠ¶æ³ç®¡ç†</span>
            </div>
            <div class="nav-item" onclick="showSection('messages', event)">
                <i>ğŸ’¬</i>
                <span>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç†</span>
                <span class="badge" id="messagesBadge" style="display: none;">0</span>
            </div>
            <div class="nav-item" onclick="showSection('approvals', event)">
                <i>âœ…</i>
                <span>è²·å–æ‰¿èªç®¡ç†</span>
                <span class="badge" id="approvalsBadge" style="display: none;">0</span>
            </div>
            <div class="nav-item" onclick="showSection('service', event)">
                <i>âš™ï¸</i>
                <span>ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³è¨­å®š</span>
            </div>
            <div class="nav-item" onclick="showSection('schedule', event)">
                <i>ğŸ“…</i>
                <span>ç™ºé€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</span>
            </div>
            <div class="nav-item" onclick="showSection('form-submissions', event)">
                <i>ğŸ“‹</i>
                <span>ãƒ•ã‚©ãƒ¼ãƒ ç”³è«‹ç®¡ç†</span>
            </div>
        </div>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
        <div class="content">
            <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
            <div id="dashboard-section" class="section">
                <div class="content-header">
                    <h2 class="content-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                </div>

                <div class="grid">
                    <div class="card">
                        <div class="card-title">æœ¬æ—¥ã®ç”³è¾¼</div>
                        <div style="font-size: 32px; font-weight: bold; color: #667eea;">
                            <span id="todayApplications">0</span>ä»¶
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">å‡¦ç†ä¸­</div>
                        <div style="font-size: 32px; font-weight: bold; color: #f39c12;">
                            <span id="inProgress">0</span>ä»¶
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">å®Œäº†</div>
                        <div style="font-size: 32px; font-weight: bold; color: #27ae60;">
                            <span id="completed">0</span>ä»¶
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">æœ€è¿‘ã®ç”³è¾¼</div>
                    <table id="recentApplicationsTable">
                        <thead>
                            <tr>
                                <th>ç”³è¾¼ID</th>
                                <th>é¡§å®¢å</th>
                                <th>ç”³è¾¼æ—¥æ™‚</th>
                                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="card">
                    <div class="card-title">ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³</div>
                    <div class="service-grid" id="serviceStatusGrid"></div>
                </div>
            </div>

            <!-- ä»£è¡Œç”³è¾¼ç®¡ç† -->
            <div id="applications-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">ä»£è¡Œç”³è¾¼ç®¡ç†</h2>
                    <button class="btn btn-primary" onclick="showApplicationForm()">æ–°è¦ç”³è¾¼è¿½åŠ </button>
                </div>

                <div class="card">
                    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                    <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center;">
                        <input type="text" id="applicationSearch" placeholder="é¡§å®¢åãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ»IDã§æ¤œç´¢..."
                               style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;"
                               onkeyup="filterApplications()">
                        <select id="applicationStatus" onchange="filterApplications()"
                                style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="">å…¨ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                            <option value="pending">ç”³è«‹æ¸ˆã¿</option>
                            <option value="processing">å‡¦ç†ä¸­</option>
                            <option value="shipped">ç™ºé€æ¸ˆã¿</option>
                            <option value="grading">é‘‘å®šä¸­</option>
                            <option value="completed">å®Œäº†</option>
                            <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                        </select>
                        <select id="applicationSort" onchange="sortApplications()"
                                style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="date_desc">æ–°ã—ã„é †</option>
                            <option value="date_asc">å¤ã„é †</option>
                            <option value="amount_desc">é‡‘é¡ãŒé«˜ã„é †</option>
                            <option value="amount_asc">é‡‘é¡ãŒä½ã„é †</option>
                        </select>
                    </div>

                    <table id="applicationsTable">
                        <thead>
                            <tr>
                                <th style="width: 120px;">ç”³è¾¼ID</th>
                                <th>é¡§å®¢å</th>
                                <th>ãƒ¡ãƒ¼ãƒ«/é›»è©±</th>
                                <th style="width: 80px;">ã‚«ãƒ¼ãƒ‰æšæ•°</th>
                                <th style="width: 100px;">ã‚µãƒ¼ãƒ“ã‚¹</th>
                                <th style="width: 100px;">é‡‘é¡</th>
                                <th style="width: 140px;">ç”³è¾¼æ—¥æ™‚</th>
                                <th style="width: 100px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th style="width: 120px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- é€²æ—çŠ¶æ³ç®¡ç† -->
            <div id="progress-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">é€²æ—çŠ¶æ³ç®¡ç†</h2>
                    <button class="btn btn-primary" onclick="showProgressPlanForm()">æ–°è¦ãƒ—ãƒ©ãƒ³ä½œæˆ</button>
                </div>

                <!-- ãƒ—ãƒ©ãƒ³é¸æŠ -->
                <div class="card">
                    <div class="card-title">ä»£è¡Œãƒ—ãƒ©ãƒ³ç®¡ç†</div>
                    <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div class="form-group">
                            <label>æ—¥ä»˜</label>
                            <input type="date" id="progressPlanDate" onchange="filterProgressPlans()">
                        </div>
                        <div class="form-group">
                            <label>é‘‘å®šã®å›½</label>
                            <select id="progressCountry" onchange="filterProgressPlans()">
                                <option value="">å…¨ã¦</option>
                                <option value="usa">ğŸ‡ºğŸ‡¸ ã‚¢ãƒ¡ãƒªã‚«</option>
                                <option value="japan">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ãƒ—ãƒ©ãƒ³</label>
                            <select id="progressPlanType" onchange="filterProgressPlans()">
                                <option value="">å…¨ã¦</option>
                                <option value="value-bulk">ãƒãƒªãƒ¥ãƒ¼ãƒãƒ«ã‚¯</option>
                                <option value="economy">ã‚¨ã‚³ãƒãƒŸãƒ¼</option>
                                <option value="standard">ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰</option>
                                <option value="express">ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ã‚¹</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é¡§å®¢é¸æŠ</label>
                            <select id="progressCustomerSelect" onchange="loadProgressForCustomer()">
                                <option value="">é¡§å®¢ã‚’é¸æŠ</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 6ã‚¹ãƒ†ãƒƒãƒ—é€²æ—ç®¡ç† -->
                <div id="progressStepsContainer" style="display: none;">
                    <!-- ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
                    <div class="card">
                        <div class="progress-steps">
                            <div class="progress-step" id="step1" onclick="showStepDetails(1)">
                                <div class="step-number">1</div>
                                <div class="step-label">ç”³è¾¼å—ä»˜</div>
                            </div>
                            <div class="progress-line"></div>
                            <div class="progress-step" id="step2" onclick="showStepDetails(2)">
                                <div class="step-number">2</div>
                                <div class="step-label">ã‚«ãƒ¼ãƒ‰å—é ˜ãƒ»æ¤œå“</div>
                            </div>
                            <div class="progress-line"></div>
                            <div class="progress-step" id="step3" onclick="showStepDetails(3)">
                                <div class="step-number">3</div>
                                <div class="step-label">ä»£è¡Œæ–™ãŠæ”¯æ‰•ã„</div>
                            </div>
                            <div class="progress-line"></div>
                            <div class="progress-step" id="step4" onclick="showStepDetails(4)">
                                <div class="step-number">4</div>
                                <div class="step-label">PSAé‘‘å®šä¸­</div>
                            </div>
                            <div class="progress-line"></div>
                            <div class="progress-step" id="step5" onclick="showStepDetails(5)">
                                <div class="step-number">5</div>
                                <div class="step-label">é‘‘å®šæ–™ãŠæ”¯æ‰•ã„</div>
                            </div>
                            <div class="progress-line"></div>
                            <div class="progress-step" id="step6" onclick="showStepDetails(6)">
                                <div class="step-number">6</div>
                                <div class="step-label">è¿”é€ãƒ»å®Œäº†</div>
                            </div>
                        </div>
                    </div>

                    <!-- å„ã‚¹ãƒ†ãƒƒãƒ—ã®è©³ç´°å…¥åŠ› -->
                    <div class="card" id="stepDetailsCard">
                        <div class="card-title" id="stepDetailsTitle">ã‚¹ãƒ†ãƒƒãƒ—è©³ç´°</div>
                        <div id="stepDetailsContent"></div>
                    </div>
                </div>
            </div>

            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç† -->
            <div id="messages-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç†</h2>
                    <button class="btn btn-primary" onclick="showMessageForm()">æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</button>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="switchMessageTab('inbox')">å—ä¿¡ç®±</div>
                    <div class="tab" onclick="switchMessageTab('sent')">é€ä¿¡æ¸ˆã¿</div>
                </div>

                <div class="card">
                    <table id="messagesTable">
                        <thead>
                            <tr>
                                <th>æ—¥æ™‚</th>
                                <th>é€ä¿¡è€…</th>
                                <th>å®›å…ˆ</th>
                                <th>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
                                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- è²·å–æ‰¿èªç®¡ç† -->
            <div id="approvals-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">è²·å–æ‰¿èªç®¡ç†</h2>
                    <button class="btn btn-primary" onclick="showApprovalForm()">æ–°è¦æ‰¿èªç”³è«‹</button>
                </div>

                <div class="card">
                    <table id="approvalsTable">
                        <thead>
                            <tr>
                                <th>æ‰¿èªã‚­ãƒ¼</th>
                                <th>é¡§å®¢å</th>
                                <th>ç·é¡</th>
                                <th>ç”³è«‹æ—¥æ™‚</th>
                                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³è¨­å®š -->
            <div id="service-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³è¨­å®š</h2>
                </div>

                <div class="card">
                    <div class="card-title">ã‚µãƒ¼ãƒ“ã‚¹ç¨¼åƒçŠ¶æ³</div>
                    <div class="service-grid" id="serviceManagementGrid"></div>
                </div>

                <div class="card">
                    <div class="card-title">ãŠçŸ¥ã‚‰ã›è¨­å®š</div>
                    <div class="form-group">
                        <label>ãŠçŸ¥ã‚‰ã›æ–‡ï¼ˆåˆ©ç”¨è€…ã‚µã‚¤ãƒˆã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</label>
                        <textarea id="serviceAnnouncement" rows="4"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="updateServiceStatus()">æ›´æ–°</button>
                </div>
            </div>

            <!-- ç™ºé€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« -->
            <div id="schedule-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">ç™ºé€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†</h2>
                </div>

                <div class="grid">
                    <div class="schedule-card">
                        <div style="color: #2c3e50; font-size: 16px; margin-bottom: 10px;">ğŸ‡ºğŸ‡¸ ã‚¢ãƒ¡ãƒªã‚«ç™ºé€</div>
                        <div class="schedule-date" id="currentNextShipDateUSA">æœªè¨­å®š</div>
                        <div class="schedule-label">æ¬¡å›ç™ºé€äºˆå®šæ—¥</div>
                    </div>
                    <div class="schedule-card">
                        <div style="color: #2c3e50; font-size: 16px; margin-bottom: 10px;">ğŸ‡¯ğŸ‡µ æ—¥æœ¬ç™ºé€</div>
                        <div class="schedule-date" id="currentNextShipDateJapan">æœªè¨­å®š</div>
                        <div class="schedule-label">æ¬¡å›ç™ºé€äºˆå®šæ—¥</div>
                    </div>
                </div>

                <div class="grid">
                    <div class="card">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">ğŸ‡ºğŸ‡¸ ã‚¢ãƒ¡ãƒªã‚«ç™ºé€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
                        <div class="form-group">
                            <label>æ¬¡å›ç™ºé€æ—¥</label>
                            <input type="date" id="nextShipDateUSA">
                        </div>
                        <div class="form-group">
                            <label>å‚™è€ƒ</label>
                            <textarea id="scheduleNotesUSA" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="card">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">ğŸ‡¯ğŸ‡µ æ—¥æœ¬ç™ºé€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
                        <div class="form-group">
                            <label>æ¬¡å›ç™ºé€æ—¥</label>
                            <input type="date" id="nextShipDateJapan">
                        </div>
                        <div class="form-group">
                            <label>å‚™è€ƒ</label>
                            <textarea id="scheduleNotesJapan" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="updateSchedule()">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ›´æ–°</button>
                </div>
            </div>

            <!-- ãƒ•ã‚©ãƒ¼ãƒ ç”³è«‹ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="form-submissions-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">ãƒ•ã‚©ãƒ¼ãƒ ç”³è«‹ç®¡ç†</h2>
                </div>

                <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="card" style="margin-bottom: 2rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                        <select id="statusFilter" class="form-control" style="max-width: 200px;" onchange="filterSubmissions()">
                            <option value="">ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                            <option value="pending">ä¿ç•™ä¸­</option>
                            <option value="processing">å‡¦ç†ä¸­</option>
                            <option value="completed">å®Œäº†</option>
                            <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                        </select>

                        <input type="text" id="searchSubmissions" class="form-control" placeholder="é¡§å®¢åãƒ»ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢..."
                               style="max-width: 300px;" oninput="filterSubmissions()">

                        <button class="btn btn-primary" onclick="loadFormSubmissions()">
                            <i class="fas fa-sync"></i> æ›´æ–°
                        </button>
                    </div>
                </div>

                <!-- ç”³è«‹ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="card">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ç”³è«‹ID</th>
                                <th>é¡§å®¢å</th>
                                <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                <th>ãƒ—ãƒ©ãƒ³</th>
                                <th>ã‚¢ã‚¤ãƒ†ãƒ æ•°</th>
                                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th>ç”³è«‹æ—¥æ™‚</th>
                                <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                            </tr>
                        </thead>
                        <tbody id="submissionsTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 2rem;">
                                    <div class="spinner"></div>
                                    ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ãƒ•ã‚©ãƒ¼ãƒ ç”³è«‹è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div id="submissionDetailModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3 id="submissionModalTitle">ç”³è«‹è©³ç´°</h3>
                        <span class="close" onclick="closeSubmissionDetailModal()">&times;</span>
                    </div>
                    <div class="modal-body" id="submissionModalBody">
                        <!-- è©³ç´°å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
            </div>

            <!-- é¡§å®¢ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="customers-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">Shopifyé¡§å®¢ä¸€è¦§</h2>
                    <button class="btn btn-primary" onclick="refreshCustomers()">
                        <i>ğŸ”„</i> æ›´æ–°
                    </button>
                </div>

                <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(102, 126, 234, 0.1); color: #667eea;">
                            <i>ğŸ‘¥</i>
                        </div>
                        <div class="stat-value" id="totalShopifyCustomers">0</div>
                        <div class="stat-label">ç·é¡§å®¢æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(52, 211, 153, 0.1); color: #34d399;">
                            <i>ğŸ›’</i>
                        </div>
                        <div class="stat-value" id="totalShopifyOrders">0</div>
                        <div class="stat-label">ç·æ³¨æ–‡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(251, 146, 60, 0.1); color: #fb923c;">
                            <i>ğŸ’´</i>
                        </div>
                        <div class="stat-value" id="totalShopifyRevenue">Â¥0</div>
                        <div class="stat-label">ç·å£²ä¸Š</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(147, 51, 234, 0.1); color: #9333ea;">
                            <i>ğŸ“ˆ</i>
                        </div>
                        <div class="stat-value" id="activeShopifyCustomers">0</div>
                        <div class="stat-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–é¡§å®¢</div>
                    </div>
                </div>

                <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 250px; position: relative;">
                            <input
                                type="text"
                                class="form-control"
                                id="shopifySearchInput"
                                placeholder="é¡§å®¢åã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ¤œç´¢..."
                                oninput="handleShopifySearch()"
                                style="padding-left: 2.5rem;"
                            >
                            <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #9ca3af;">
                                ğŸ”
                            </span>
                        </div>
                        <select class="form-control" id="shopifySortSelect" onchange="handleShopifySort()" style="width: auto;">
                            <option value="name">åå‰é †</option>
                            <option value="email">ãƒ¡ãƒ¼ãƒ«é †</option>
                            <option value="orders">æ³¨æ–‡æ•°é †</option>
                            <option value="spent">è³¼å…¥é¡é †</option>
                            <option value="date">ç™»éŒ²æ—¥é †</option>
                        </select>
                    </div>
                </div>

                <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="card">
                    <div class="table-responsive">
                        <table class="table" id="shopifyCustomersTable">
                            <thead>
                                <tr>
                                    <th>é¡§å®¢å</th>
                                    <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                    <th>é›»è©±ç•ªå·</th>
                                    <th>æ³¨æ–‡æ•°</th>
                                    <th>ç·è³¼å…¥é¡</th>
                                    <th>ç™»éŒ²æ—¥</th>
                                    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="shopifyCustomersTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="sr-only">èª­ã¿è¾¼ã¿ä¸­...</span>
                                        </div>
                                        é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">ã‚¿ã‚¤ãƒˆãƒ«</h3>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentData = {
            applications: [],
            progress: [],
            messages: [],
            approvals: [],
            serviceStatus: {},
            schedule: {},
            statistics: {}
        };

        // é€šçŸ¥è¡¨ç¤ºé–¢æ•°
        function showNotification(message, type = 'success') {
            // æ—¢å­˜ã®é€šçŸ¥ã‚’å‰Šé™¤
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());

            // æ–°ã—ã„é€šçŸ¥ã‚’ä½œæˆ
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            // 3ç§’å¾Œã«é€šçŸ¥ã‚’å‰Šé™¤
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // ç„¡é™ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆé˜²æ­¢
            const redirectCount = parseInt(sessionStorage.getItem('redirectCount') || '0');
            if (redirectCount > 3) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ï¼šç„¡é™ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚\nã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                sessionStorage.removeItem('redirectCount');
                localStorage.clear(); // ãƒˆãƒ¼ã‚¯ãƒ³ã‚‚ã‚¯ãƒªã‚¢
                window.location.href = '/login.html';
                return;
            }
            sessionStorage.setItem('redirectCount', (redirectCount + 1).toString());

            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            if (!authAPI.isAuthenticated()) {
                showNotification('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™', 'error');
                setTimeout(() => {
                    sessionStorage.removeItem('redirectCount'); // æ­£å¸¸ãªãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã®å ´åˆã¯ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                    sessionStorage.setItem('redirectFromAdmin', 'true'); // admin.html ã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è¨˜éŒ²
                    window.location.href = '/login.html';
                }, 1500);
                return;
            }

            // èªè¨¼æˆåŠŸæ™‚ã¯ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
            sessionStorage.removeItem('redirectCount');

            // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
            try {
                const isAdmin = await authAPI.isAdmin();
                if (!isAdmin) {
                    showNotification('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™', 'error');
                    sessionStorage.removeItem('redirectCount');
                    sessionStorage.setItem('redirectFromAdmin', 'true'); // admin.html ã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è¨˜éŒ²
                    setTimeout(() => {
                        // logout()ã§ã¯ãªãã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                        apiClient.removeToken();
                        window.location.href = '/login.html';
                    }, 1500);
                    return;
                }
            } catch (error) {
                console.error('æ¨©é™ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                showNotification('æ¨©é™ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                sessionStorage.removeItem('redirectCount');
                sessionStorage.setItem('redirectFromAdmin', 'true'); // admin.html ã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è¨˜éŒ²
                setTimeout(() => {
                    // logout()ã§ã¯ãªãã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    apiClient.removeToken();
                    window.location.href = '/login.html';
                }, 1500);
                return;
            }

            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadStatistics();
            loadAllData();
            setInterval(loadStatistics, 30000); // 30ç§’ã”ã¨ã«çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°

            // å‰å›è¡¨ç¤ºã—ã¦ã„ãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¾©å…ƒ
            const lastSection = localStorage.getItem('currentSection') || 'dashboard';
            if (lastSection !== 'dashboard') {
                showSection(lastSection);
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        async function handleLogout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                try {
                    await authAPI.logout();
                    showNotification('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'success');
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 1000);
                } catch (error) {
                    console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’ç¶šè¡Œ
                    apiClient.removeToken();
                    window.location.href = '/login.html';
                }
            }
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadAllData() {
            await Promise.all([
                loadApplications(),
                loadProgress(),
                loadMessages(),
                loadApprovals(),
                loadServiceStatus(),
                loadSchedule()
            ]);
            updateDashboard();
        }

        async function loadStatistics() {
            try {
                // APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆã‚’å–å¾—
                const dashboard = await adminAPI.getDashboard();
                currentData.statistics = {
                    totalApplications: dashboard.totalForms || 0,
                    pendingApprovals: dashboard.pendingForms || 0,
                    unreadMessages: dashboard.unreadMessages || 0,
                    inProgressApplications: dashboard.processingForms || 0,
                    completedApplications: dashboard.completedForms || 0,
                    pendingApplications: dashboard.pendingForms || 0
                };
                updateHeaderStats();

                // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                if (dashboard.recentForms) {
                    currentData.recentApplications = dashboard.recentForms;
                }
            } catch (error) {
                console.error('Failed to load statistics:', error);
                // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«APIã‚’è©¦ã¿ã‚‹
                try {
                    const response = await fetch('/api/statistics');
                    const data = await response.json();
                    if (data.success) {
                        currentData.statistics = data.data;
                        updateHeaderStats();
                    }
                } catch (localError) {
                    console.error('Local API also failed:', localError);
                }
            }
        }

        async function loadApplications() {
            try {
                // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
                const token = localStorage.getItem('kanucard_admin_token');

                // APIã‹ã‚‰ç”³è«‹ä¸€è¦§ã‚’å–å¾—
                const response = await fetch('/api/psa-requests', {
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : '',
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                if (data.success) {
                    currentData.applications = data.data;
                    updateApplicationsTable();
                } else {
                    throw new Error(data.message || 'ç”³è«‹ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Failed to load applications:', error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºé…åˆ—ã‚’è¨­å®š
                currentData.applications = [];
                updateApplicationsTable();
            }
        }

        async function loadProgress() {
            try {
                const response = await fetch('/api/progress');
                const data = await response.json();
                if (data.success) {
                    currentData.progress = data.data;
                    updateProgressPlans();
                }
            } catch (error) {
                console.error('Failed to load progress:', error);
            }
        }

        // é€²æ—ãƒ—ãƒ©ãƒ³ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨è¡¨ç¤º
        function updateProgressPlans() {
            const customerSelect = document.getElementById('progressCustomerSelect');
            const applications = currentData.applications;

            customerSelect.innerHTML = '<option value="">é¡§å®¢ã‚’é¸æŠ</option>';
            applications.forEach(app => {
                customerSelect.innerHTML += `
                    <option value="${app.id}">${app.customerName} - ${app.id.substring(0, 8)}</option>
                `;
            });
        }

        function filterProgressPlans() {
            const date = document.getElementById('progressPlanDate').value;
            const country = document.getElementById('progressCountry').value;
            const planType = document.getElementById('progressPlanType').value;

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†
            updateProgressPlans();
        }

        async function loadProgressForCustomer() {
            const applicationId = document.getElementById('progressCustomerSelect').value;
            if (!applicationId) {
                document.getElementById('progressStepsContainer').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/api/progress/${applicationId}`);
                const data = await response.json();
                if (data.success) {
                    currentData.currentProgress = data.data;
                    displayProgressSteps(data.data);
                    document.getElementById('progressStepsContainer').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load progress:', error);
            }
        }

        function displayProgressSteps(progress) {
            if (!progress || !progress.steps) return;

            // å„ã‚¹ãƒ†ãƒƒãƒ—ã®çŠ¶æ…‹ã‚’æ›´æ–°
            for (let i = 1; i <= 6; i++) {
                const step = document.getElementById(`step${i}`);
                const stepData = progress.steps[`step${i}`];

                if (stepData) {
                    step.className = 'progress-step';
                    if (stepData.status === 'completed') {
                        step.classList.add('completed');
                    } else if (stepData.status === 'current') {
                        step.classList.add('current');
                    } else if (stepData.status === 'active') {
                        step.classList.add('active');
                    }
                }
            }

            // é€²æ—ãƒ©ã‚¤ãƒ³ã®æ›´æ–°
            const lines = document.querySelectorAll('.progress-line');
            for (let i = 0; i < lines.length; i++) {
                const stepData = progress.steps[`step${i + 1}`];
                if (stepData && stepData.status === 'completed') {
                    lines[i].classList.add('completed');
                } else {
                    lines[i].classList.remove('completed');
                }
            }
        }

        let currentStepNumber = 1;
        function showStepDetails(stepNumber) {
            currentStepNumber = stepNumber;
            const stepDetailsContent = document.getElementById('stepDetailsContent');
            const stepDetailsTitle = document.getElementById('stepDetailsTitle');

            const stepTitles = {
                1: '1. ç”³è¾¼å—ä»˜',
                2: '2. ã‚«ãƒ¼ãƒ‰å—é ˜ãƒ»æ¤œå“',
                3: '3. ä»£è¡Œæ–™ã®ãŠæ”¯æ‰•ã„',
                4: '4. PSAé‘‘å®šä¸­',
                5: '5. é‘‘å®šæ–™ãŠæ”¯æ‰•ã„',
                6: '6. è¿”é€ãƒ»å®Œäº†'
            };

            stepDetailsTitle.textContent = stepTitles[stepNumber];

            const progress = currentData.currentProgress;
            const stepData = progress?.steps[`step${stepNumber}`] || {};

            switch (stepNumber) {
                case 1:
                    stepDetailsContent.innerHTML = `
                        <p>ç”³è¾¼å—ä»˜ã¯å®Œäº†ã—ã¦ã„ã¾ã™ã€‚</p>
                        <div class="form-group">
                            <label>å—ä»˜æ—¥æ™‚</label>
                            <input type="datetime-local" value="${stepData.date || ''}" readonly class="form-control">
                        </div>
                        <div class="form-group">
                            <label>å‚™è€ƒ</label>
                            <textarea class="form-control" readonly>${stepData.notes || 'ç”³è¾¼å—ä»˜å®Œäº†'}</textarea>
                        </div>
                    `;
                    break;

                case 2:
                    stepDetailsContent.innerHTML = `
                        <p>ã‚«ãƒ¼ãƒ‰å—é ˜ãƒ»æ¤œå“ã«ã¤ã„ã¦</p>
                        <div class="form-group">
                            <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                            <select id="step2Status" class="form-control">
                                <option value="pending">æœªå—é ˜</option>
                                <option value="completed">å—é ˜å®Œäº†</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å—é ˜æ—¥</label>
                            <input type="date" id="step2Date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>å‚™è€ƒ</label>
                            <textarea id="step2Notes" class="form-control"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="updateStep(2)">æ›´æ–°</button>
                    `;
                    break;

                case 3:
                    stepDetailsContent.innerHTML = `
                        <div class="payment-notice">
                            <h4>ä»£è¡Œæ–™ã®ãŠæ”¯æ‰•ã„å¾…ã¡</h4>
                            <p>Shopifyã‹ã‚‰æ±ºæ¸ˆãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚‹ã®ã§ãŠå¾…ã¡ãã ã•ã„ã€‚</p>
                        </div>
                        <div class="form-group">
                            <label>æ”¯æ‰•ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                            <select id="step3Status" class="form-control">
                                <option value="pending">æ”¯æ‰•ã„å¾…ã¡</option>
                                <option value="completed">æ”¯æ‰•ã„å®Œäº†</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Shopifyæ±ºæ¸ˆãƒªãƒ³ã‚¯</label>
                            <input type="text" id="step3PaymentLink" class="form-control" placeholder="https://...">
                        </div>
                        <button class="btn btn-primary" onclick="updateStep(3)">æ›´æ–°</button>
                        <button class="btn btn-warning" onclick="sendPaymentReminder(3)">æ±ºæ¸ˆãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€ä¿¡</button>
                    `;
                    break;

                case 4:
                    stepDetailsContent.innerHTML = `
                        <h4>PSAé‘‘å®šä¸­ - ã‚«ãƒ¼ãƒ‰æƒ…å ±ç®¡ç†</h4>
                        <div id="cardListContainer">
                            ${(stepData.cards || []).map((card, index) => `
                                <div class="card-list-item">
                                    <div>
                                        <strong>${card.name}</strong>
                                        <span class="text-muted"> - ${card.quantity}æš</span>
                                    </div>
                                    <button class="btn btn-sm btn-danger" onclick="removeCard(${index})">å‰Šé™¤</button>
                                </div>
                            `).join('')}
                        </div>
                        <div class="step-form-grid">
                            <div class="form-group">
                                <label>ã‚«ãƒ¼ãƒ‰å</label>
                                <input type="text" id="cardName" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>æšæ•°</label>
                                <input type="number" id="cardQuantity" class="form-control" value="1">
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="addCard()">ã‚«ãƒ¼ãƒ‰è¿½åŠ </button>
                        <button class="btn btn-primary" onclick="updateStep(4)">æ›´æ–°</button>
                    `;
                    break;

                case 5:
                    stepDetailsContent.innerHTML = `
                        <h4>é‘‘å®šæ–™ãŠæ”¯æ‰•ã„è¨­å®š</h4>
                        <div class="fee-input-group">
                            <div class="form-group">
                                <label>é‘‘å®šæ–™</label>
                                <input type="number" id="gradingFee" class="form-control" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>è¼¸å‡ºå…¥é€æ–™</label>
                                <input type="number" id="shippingFee" class="form-control" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>è¿½åŠ ä»£è¡Œæ–™</label>
                                <input type="number" id="additionalFee" class="form-control" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>ãã®ä»–è²»ç”¨</label>
                                <input type="number" id="otherFee" class="form-control" placeholder="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>åˆè¨ˆé‡‘é¡</label>
                            <input type="number" id="totalFee" class="form-control" readonly>
                        </div>
                        <div class="buyback-link" onclick="showBuybackOption()">
                            ğŸ›’ è²·å–å¸Œæœ›è€…å‘ã‘ãƒšãƒ¼ã‚¸ã¸ã®æ¡ˆå†…ã‚’è¿½åŠ 
                        </div>
                        <button class="btn btn-primary" onclick="updateStep(5)">æ›´æ–°</button>
                        <button class="btn btn-warning" onclick="sendPaymentRequest(5)">æ”¯æ‰•ã„è«‹æ±‚é€ä¿¡</button>
                    `;

                    // åˆè¨ˆé‡‘é¡ã®è‡ªå‹•è¨ˆç®—
                    ['gradingFee', 'shippingFee', 'additionalFee', 'otherFee'].forEach(id => {
                        document.getElementById(id).addEventListener('input', calculateTotalFee);
                    });
                    break;

                case 6:
                    stepDetailsContent.innerHTML = `
                        <h4>è¿”é€ãƒ»å®Œäº†ç®¡ç†</h4>
                        <div id="trackingNumbersContainer">
                            ${Object.entries(stepData.trackingNumbers || {}).map(([customer, tracking]) => `
                                <div class="tracking-input">
                                    <label>${customer}</label>
                                    <input type="text" value="${tracking}" class="form-control" data-customer="${customer}">
                                </div>
                            `).join('')}
                        </div>
                        <div class="form-group">
                            <label>æ–°è¦è¿½è·¡ç•ªå·</label>
                            <div class="step-form-grid">
                                <input type="text" id="trackingCustomer" class="form-control" placeholder="é¡§å®¢å">
                                <input type="text" id="trackingNumber" class="form-control" placeholder="è¿½è·¡ç•ªå·">
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="addTrackingNumber()">è¿½è·¡ç•ªå·è¿½åŠ </button>
                        <button class="btn btn-primary" onclick="updateStep(6)">æ›´æ–°</button>
                        <button class="btn btn-info" onclick="sendShippingNotification(6)">ç™ºé€é€šçŸ¥é€ä¿¡</button>
                    `;
                    break;
            }
        }

        async function loadMessages() {
            try {
                const response = await fetch('/api/messages');
                const data = await response.json();
                if (data.success) {
                    currentData.messages = data.data;
                    updateMessagesTable();
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }

        async function loadApprovals() {
            try {
                const response = await fetch('/api/approvals');
                const data = await response.json();
                if (data.success) {
                    currentData.approvals = data.data;
                    updateApprovalsTable();
                }
            } catch (error) {
                console.error('Failed to load approvals:', error);
            }
        }

        async function loadServiceStatus() {
            try {
                const response = await fetch('/api/service-status');
                const data = await response.json();
                if (data.success) {
                    currentData.serviceStatus = data.data;
                    // updateServiceStatusDisplayé–¢æ•°ã‚’è¿½åŠ 
                    if (typeof updateServiceStatusDisplay === 'function') {
                        updateServiceStatusDisplay();
                    } else {
                        // ã‚µãƒ¼ãƒ“ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
                        console.log('Service status updated:', data.data);
                    }
                }
            } catch (error) {
                console.error('Failed to load service status:', error);
            }
        }

        async function loadSchedule() {
            try {
                const response = await fetch('/api/schedule');
                const data = await response.json();
                if (data.success) {
                    currentData.schedule = data.data;
                    updateScheduleDisplay();
                }
            } catch (error) {
                console.error('Failed to load schedule:', error);
            }
        }

        // UIæ›´æ–°é–¢æ•°
        function updateHeaderStats() {
            const stats = currentData.statistics;
            document.getElementById('totalApplications').textContent = stats.totalApplications || 0;
            document.getElementById('pendingApprovals').textContent = stats.pendingApprovals || 0;
            document.getElementById('unreadMessages').textContent = stats.unreadMessages || 0;

            // ã‚¢ãƒ¡ãƒªã‚«ã¨æ—¥æœ¬ã®æ¬¡å›ç™ºé€æ—¥ã‚’è¡¨ç¤ºï¼ˆæœ€ã‚‚è¿‘ã„æ—¥ä»˜ã‚’è¡¨ç¤ºï¼‰
            let nextDate = null;
            if (stats.nextShipDateUSA && stats.nextShipDateJapan) {
                const usaDate = new Date(stats.nextShipDateUSA);
                const japanDate = new Date(stats.nextShipDateJapan);
                nextDate = usaDate < japanDate ? usaDate : japanDate;
            } else if (stats.nextShipDateUSA) {
                nextDate = new Date(stats.nextShipDateUSA);
            } else if (stats.nextShipDateJapan) {
                nextDate = new Date(stats.nextShipDateJapan);
            }

            document.getElementById('nextShipDate').textContent =
                nextDate ? nextDate.toLocaleDateString('ja-JP') : '-';

            // ãƒãƒƒã‚¸æ›´æ–°
            updateBadge('applicationsBadge', stats.pendingApplications);
            updateBadge('messagesBadge', stats.unreadMessages);
            updateBadge('approvalsBadge', stats.pendingApprovals);
        }

        function updateBadge(elementId, count) {
            const badge = document.getElementById(elementId);
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function updateDashboard() {
            const stats = currentData.statistics;
            document.getElementById('todayApplications').textContent =
                currentData.applications.filter(a => {
                    const today = new Date().toDateString();
                    return new Date(a.createdAt).toDateString() === today;
                }).length;

            document.getElementById('inProgress').textContent = stats.inProgressApplications || 0;
            document.getElementById('completed').textContent = stats.completedApplications || 0;

            // æœ€è¿‘ã®ç”³è¾¼
            const recentApplications = currentData.applications.slice(0, 5);
            const tbody = document.querySelector('#recentApplicationsTable tbody');
            tbody.innerHTML = recentApplications.map(app => `
                <tr>
                    <td>${app.id.substring(0, 8)}</td>
                    <td>${app.customerName || '-'}</td>
                    <td>${new Date(app.createdAt).toLocaleString('ja-JP')}</td>
                    <td><span class="status status-${app.status}">${getStatusLabel(app.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewApplication('${app.id}')">è©³ç´°</button>
                    </td>
                </tr>
            `).join('');

            // ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³
            if (currentData.serviceStatus.services) {
                document.getElementById('serviceStatusGrid').innerHTML =
                    currentData.serviceStatus.services.map(service => `
                        <div class="service-card ${service.status}">
                            <div style="font-size: 18px; font-weight: bold;">${service.name}</div>
                            <div style="margin-top: 5px; color: ${service.status === 'active' ? '#27ae60' : '#e74c3c'};">
                                ${service.status === 'active' ? 'ç¨¼åƒä¸­' : 'åœæ­¢ä¸­'}
                            </div>
                        </div>
                    `).join('');
            }
        }

        function updateApplicationsTable() {
            const tbody = document.querySelector('#applicationsTable tbody');

            // ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¡¨ç¤ºã™ã‚‹ç”³è«‹ãƒ‡ãƒ¼ã‚¿
            tbody.innerHTML = currentData.applications.map(app => {
                const customerEmail = app.customerEmail || '';
                const customerEmailDisplay = customerEmail ?
                    `<a href="/customer-detail.html?email=${encodeURIComponent(customerEmail)}"
                       style="color: #1a73e8; text-decoration: none;"
                       title="Shopifyæ³¨æ–‡å±¥æ­´ã‚’è¡¨ç¤º">${customerEmail}</a>` : '-';

                // ç”³è«‹IDã®è¡¨ç¤ºï¼ˆæ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¯¾å¿œï¼‰
                const applicationId = app.applicationId || app.id || '-';
                const displayId = applicationId.length > 15 ?
                    applicationId.substring(0, 15) + '...' : applicationId;

                // ã‚µãƒ¼ãƒ“ã‚¹ã‚¿ã‚¤ãƒ—ã®è¡¨ç¤º
                const serviceType = app.serviceType === 'express' ?
                    '<span style="color: #ff6b6b; font-weight: bold;">ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ã‚¹</span>' :
                    '<span style="color: #4dabf7; font-weight: bold;">ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰</span>';

                // é‡‘é¡ã®è¡¨ç¤º
                const amountDisplay = app.totalAmount ?
                    `<strong>Â¥${Math.floor(app.totalAmount).toLocaleString()}</strong>` : '-';

                // ã‚«ãƒ¼ãƒ‰æšæ•°ã®è¡¨ç¤º
                const cardCount = app.cardCount || app.cards?.length || 0;

                // é€ä¿¡æ—¥æ™‚ã®å‡¦ç†ï¼ˆsubmittedAtã‚‚ã‚µãƒãƒ¼ãƒˆï¼‰
                const submitDate = app.createdAt || app.submittedAt || app.lastUpdated;

                return `
                    <tr>
                        <td title="${applicationId}"><small>${displayId}</small></td>
                        <td><strong>${app.customerName || '-'}</strong></td>
                        <td>
                            ${customerEmailDisplay}<br>
                            <small style="color: #666;">${app.customerPhone || '-'}</small>
                        </td>
                        <td style="text-align: center;">
                            <span style="font-size: 1.2em; font-weight: bold; color: #2d3436;">${cardCount}</span>
                        </td>
                        <td>${serviceType || '-'}</td>
                        <td style="color: #2d3436;">${amountDisplay}</td>
                        <td><small>${new Date(submitDate).toLocaleString('ja-JP')}</small></td>
                        <td><span class="status status-${app.status}">${getStatusLabel(app.status)}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewApplication('${app.id}')">è©³ç´°</button>
                            ${customerEmail ? `<button class="btn btn-sm btn-info" onclick="viewCustomerHistory('${customerEmail}')">
                                <i class="fas fa-shopping-cart"></i>
                            </button>` : ''}
                            <button class="btn btn-sm btn-success" onclick="updateApplicationStatus('${app.id}')">æ›´æ–°</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // ç”³è«‹æ•°ã‚’ãƒãƒƒã‚¸ã«è¡¨ç¤º
            const applicationsBadge = document.getElementById('applicationsBadge');
            if (applicationsBadge) {
                const pendingCount = currentData.applications.filter(app => app.status === 'pending').length;
                if (pendingCount > 0) {
                    applicationsBadge.textContent = pendingCount;
                    applicationsBadge.style.display = 'inline-block';
                } else {
                    applicationsBadge.style.display = 'none';
                }
            }

            // é€²æ—ç®¡ç†ç”¨ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚‚æ›´æ–°
            const select = document.getElementById('progressApplicationSelect');
            if (select) {
                select.innerHTML = '<option value="">ç”³è¾¼ã‚’é¸æŠã—ã¦ãã ã•ã„</option>' +
                    currentData.applications.map(app =>
                        `<option value="${app.id}">${app.customerName} - ${(app.applicationId || app.id).substring(0, 10)}</option>`
                    ).join('');
            }
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é–¢æ•°ã‚’è¿½åŠ 
        function filterApplications() {
            updateApplicationsTable();
        }

        // ã‚½ãƒ¼ãƒˆé–¢æ•°ã‚’è¿½åŠ 
        function sortApplications() {
            const sortOrder = document.getElementById('applicationSort')?.value || 'date_desc';

            currentData.applications.sort((a, b) => {
                const dateA = new Date(a.createdAt || a.submittedAt || a.lastUpdated);
                const dateB = new Date(b.createdAt || b.submittedAt || b.lastUpdated);

                switch(sortOrder) {
                    case 'date_asc':
                        return dateA - dateB;
                    case 'date_desc':
                        return dateB - dateA;
                    case 'amount_asc':
                        return (a.totalAmount || 0) - (b.totalAmount || 0);
                    case 'amount_desc':
                        return (b.totalAmount || 0) - (a.totalAmount || 0);
                    default:
                        return 0;
                }
            });

            updateApplicationsTable();
        }

        function updateMessagesTable() {
            const tbody = document.querySelector('#messagesTable tbody');
            tbody.innerHTML = currentData.messages.map(msg => `
                <tr>
                    <td>${new Date(msg.createdAt).toLocaleString('ja-JP')}</td>
                    <td>${msg.from}</td>
                    <td>${msg.to}</td>
                    <td>${msg.message.substring(0, 50)}${msg.message.length > 50 ? '...' : ''}</td>
                    <td>${msg.read ? 'æ—¢èª­' : '<strong>æœªèª­</strong>'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewMessage('${msg.id}')">è©³ç´°</button>
                        ${!msg.read ? `<button class="btn btn-sm btn-success" onclick="markAsRead('${msg.id}')">æ—¢èª­</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function updateApprovalsTable() {
            const tbody = document.querySelector('#approvalsTable tbody');
            tbody.innerHTML = currentData.approvals.map(approval => `
                <tr>
                    <td>${approval.approvalKey}</td>
                    <td>${approval.customerName}</td>
                    <td>Â¥${(approval.totalPrice || 0).toLocaleString()}</td>
                    <td>${new Date(approval.createdAt).toLocaleString('ja-JP')}</td>
                    <td><span class="status status-${approval.status}">${getStatusLabel(approval.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewApproval('${approval.id}')">è©³ç´°</button>
                        <button class="btn btn-sm btn-warning" onclick="resendApprovalEmail('${approval.id}')">å†é€ä¿¡</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateServiceStatus() {
            if (currentData.serviceStatus.services) {
                document.getElementById('serviceManagementGrid').innerHTML =
                    currentData.serviceStatus.services.map(service => `
                        <div class="service-card ${service.status}" onclick="toggleService('${service.id}')">
                            <div style="font-size: 18px; font-weight: bold;">${service.name}</div>
                            <div style="margin-top: 5px;">
                                ${service.status === 'active' ? 'âœ… ç¨¼åƒä¸­' : 'âŒ åœæ­¢ä¸­'}
                            </div>
                            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                ã‚¯ãƒªãƒƒã‚¯ã§åˆ‡ã‚Šæ›¿ãˆ
                            </div>
                        </div>
                    `).join('');

                document.getElementById('serviceAnnouncement').value =
                    currentData.serviceStatus.announcement || '';
            }
        }

        function updateScheduleDisplay() {
            // ã‚¢ãƒ¡ãƒªã‚«ã®ç™ºé€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
            if (currentData.schedule.usa?.nextShipDate) {
                document.getElementById('currentNextShipDateUSA').textContent =
                    new Date(currentData.schedule.usa.nextShipDate).toLocaleDateString('ja-JP');
                document.getElementById('nextShipDateUSA').value =
                    currentData.schedule.usa.nextShipDate.split('T')[0];
            } else {
                document.getElementById('currentNextShipDateUSA').textContent = 'æœªè¨­å®š';
            }
            if (currentData.schedule.usa?.notes) {
                document.getElementById('scheduleNotesUSA').value = currentData.schedule.usa.notes;
            }

            // æ—¥æœ¬ã®ç™ºé€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
            if (currentData.schedule.japan?.nextShipDate) {
                document.getElementById('currentNextShipDateJapan').textContent =
                    new Date(currentData.schedule.japan.nextShipDate).toLocaleDateString('ja-JP');
                document.getElementById('nextShipDateJapan').value =
                    currentData.schedule.japan.nextShipDate.split('T')[0];
            } else {
                document.getElementById('currentNextShipDateJapan').textContent = 'æœªè¨­å®š';
            }
            if (currentData.schedule.japan?.notes) {
                document.getElementById('scheduleNotesJapan').value = currentData.schedule.japan.notes;
            }
        }

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function showSection(sectionName, event) {
            // ã™ã¹ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });

            // é¸æŠã•ã‚ŒãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            document.getElementById(`${sectionName}-section`).style.display = 'block';

            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯ã€ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            if (event && event.target) {
                const navItem = event.target.closest('.nav-item');
                if (navItem) {
                    navItem.classList.add('active');
                }
            } else {
                // ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆã¯ã€å¯¾å¿œã™ã‚‹ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é …ç›®ã‚’æ¢ã—ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(sectionName)) {
                        item.classList.add('active');
                    }
                });
            }

            // ç¾åœ¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’localStorageã«ä¿å­˜
            localStorage.setItem('currentSection', sectionName);

            // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            if (sectionName === 'dashboard') {
                updateDashboard();
            } else if (sectionName === 'customers') {
                loadShopifyCustomers();
            } else if (sectionName === 'form-submissions') {
                loadFormSubmissions();
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ«å–å¾—
        function getStatusLabel(status) {
            const labels = {
                'pending': 'ä¿ç•™ä¸­',
                'in_progress': 'å‡¦ç†ä¸­',
                'completed': 'å®Œäº†',
                'approved': 'æ‰¿èªæ¸ˆã¿',
                'rejected': 'æ‹’å¦',
                'active': 'ç¨¼åƒä¸­',
                'inactive': 'åœæ­¢ä¸­'
            };
            return labels[status] || status;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').style.display = 'flex';
        }

        // openModalã¯showModalã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹
        const openModal = showModal;

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // APIå‘¼ã³å‡ºã—é–¢æ•°
        async function updateSchedule() {
            const scheduleData = {
                usa: {
                    nextShipDate: document.getElementById('nextShipDateUSA').value,
                    notes: document.getElementById('scheduleNotesUSA').value
                },
                japan: {
                    nextShipDate: document.getElementById('nextShipDateJapan').value,
                    notes: document.getElementById('scheduleNotesJapan').value
                }
            };

            try {
                const response = await fetch('/api/schedule', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(scheduleData)
                });

                const data = await response.json();
                if (data.success) {
                    showNotification('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                    loadSchedule();
                    loadStatistics();
                }
            } catch (error) {
                showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        async function toggleService(serviceId) {
            const service = currentData.serviceStatus.services.find(s => s.id === serviceId);
            if (service) {
                service.status = service.status === 'active' ? 'inactive' : 'active';

                try {
                    const response = await fetch('/api/service-status', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(currentData.serviceStatus)
                    });

                    const data = await response.json();
                    if (data.success) {
                        loadServiceStatus();
                    }
                } catch (error) {
                    showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            }
        }

        async function updateServiceStatus() {
            currentData.serviceStatus.announcement = document.getElementById('serviceAnnouncement').value;

            try {
                const response = await fetch('/api/service-status', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentData.serviceStatus)
                });

                const data = await response.json();
                if (data.success) {
                    showNotification('ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                    loadServiceStatus();
                }
            } catch (error) {
                showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°é–¢æ•°
        async function updateStep(stepNumber) {
            const applicationId = document.getElementById('progressCustomerSelect').value;
            if (!applicationId) {
                showNotification('é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            const stepData = {};
            switch (stepNumber) {
                case 2:
                    stepData.status = document.getElementById('step2Status').value;
                    stepData.date = document.getElementById('step2Date').value;
                    stepData.notes = document.getElementById('step2Notes').value;
                    break;
                case 3:
                    stepData.status = document.getElementById('step3Status').value;
                    stepData.paymentLink = document.getElementById('step3PaymentLink').value;
                    break;
                case 4:
                    const progress = currentData.currentProgress;
                    stepData.cards = progress.steps.step4.cards || [];
                    stepData.status = 'current';
                    break;
                case 5:
                    stepData.fees = {
                        grading: parseFloat(document.getElementById('gradingFee').value) || 0,
                        shipping: parseFloat(document.getElementById('shippingFee').value) || 0,
                        additional: parseFloat(document.getElementById('additionalFee').value) || 0,
                        other: parseFloat(document.getElementById('otherFee').value) || 0
                    };
                    stepData.status = 'current';
                    break;
                case 6:
                    const trackingNumbers = {};
                    document.querySelectorAll('#trackingNumbersContainer input').forEach(input => {
                        if (input.dataset.customer) {
                            trackingNumbers[input.dataset.customer] = input.value;
                        }
                    });
                    stepData.trackingNumbers = trackingNumbers;
                    stepData.status = 'current';
                    break;
            }

            try {
                const response = await fetch(`/api/progress/${applicationId}/step/step${stepNumber}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(stepData)
                });

                const data = await response.json();
                if (data.success) {
                    showNotification(`ã‚¹ãƒ†ãƒƒãƒ—${stepNumber}ã‚’æ›´æ–°ã—ã¾ã—ãŸ`, 'success');
                    loadProgressForCustomer();
                }
            } catch (error) {
                showNotification('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚«ãƒ¼ãƒ‰ç®¡ç†é–¢æ•°
        function addCard() {
            const cardName = document.getElementById('cardName').value;
            const cardQuantity = parseInt(document.getElementById('cardQuantity').value) || 1;

            if (!cardName) {
                showNotification('ã‚«ãƒ¼ãƒ‰åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            const progress = currentData.currentProgress;
            if (!progress.steps.step4.cards) {
                progress.steps.step4.cards = [];
            }

            progress.steps.step4.cards.push({ name: cardName, quantity: cardQuantity });

            document.getElementById('cardName').value = '';
            document.getElementById('cardQuantity').value = '1';

            showStepDetails(4);
            updateStep(4);
        }

        function removeCard(index) {
            const progress = currentData.currentProgress;
            progress.steps.step4.cards.splice(index, 1);
            showStepDetails(4);
            updateStep(4);
        }

        // åˆè¨ˆé‡‘é¡è¨ˆç®—
        function calculateTotalFee() {
            const grading = parseFloat(document.getElementById('gradingFee').value) || 0;
            const shipping = parseFloat(document.getElementById('shippingFee').value) || 0;
            const additional = parseFloat(document.getElementById('additionalFee').value) || 0;
            const other = parseFloat(document.getElementById('otherFee').value) || 0;

            const total = grading + shipping + additional + other;
            document.getElementById('totalFee').value = total;
        }

        // è¿½è·¡ç•ªå·ç®¡ç†
        function addTrackingNumber() {
            const customer = document.getElementById('trackingCustomer').value;
            const tracking = document.getElementById('trackingNumber').value;

            if (!customer || !tracking) {
                showNotification('é¡§å®¢åã¨è¿½è·¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            const container = document.getElementById('trackingNumbersContainer');
            const newInput = document.createElement('div');
            newInput.className = 'tracking-input';
            newInput.innerHTML = `
                <label>${customer}</label>
                <input type="text" value="${tracking}" class="form-control" data-customer="${customer}">
            `;
            container.appendChild(newInput);

            document.getElementById('trackingCustomer').value = '';
            document.getElementById('trackingNumber').value = '';
        }

        // æ”¯æ‰•ã„ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€ä¿¡
        async function sendPaymentReminder(stepNumber) {
            const applicationId = document.getElementById('progressCustomerSelect').value;
            if (!applicationId) {
                showNotification('é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            showNotification('æ±ºæ¸ˆãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
        }

        // æ”¯æ‰•ã„è«‹æ±‚é€ä¿¡
        async function sendPaymentRequest(stepNumber) {
            const applicationId = document.getElementById('progressCustomerSelect').value;
            if (!applicationId) {
                showNotification('é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            showNotification('æ”¯æ‰•ã„è«‹æ±‚ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
        }

        // ç™ºé€é€šçŸ¥é€ä¿¡
        async function sendShippingNotification(stepNumber) {
            const applicationId = document.getElementById('progressCustomerSelect').value;
            if (!applicationId) {
                showNotification('é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            showNotification('ç™ºé€é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
        }

        // è²·å–ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤º
        function showBuybackOption() {
            showModal('è²·å–å¸Œæœ›è€…å‘ã‘æ¡ˆå†…', `
                <div class="buyback-info">
                    <h4>è²·å–å¸Œæœ›è€…å‘ã‘ãƒšãƒ¼ã‚¸ã¸ã®å°ç·š</h4>
                    <p>ã“ã®ãŠå®¢æ§˜ã«è²·å–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã”æ¡ˆå†…ã—ã¾ã™ã€‚</p>
                    <div class="form-group">
                        <label>è²·å–æ‰¿èªURL</label>
                        <input type="text" id="buybackUrl" class="form-control" value="https://kanucard-daiko-support.onrender.com/buyback" readonly>
                    </div>
                    <div class="form-group">
                        <label>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
                        <textarea id="buybackMessage" class="form-control" rows="4">PSAé‘‘å®šå¾Œã®ã‚«ãƒ¼ãƒ‰ã®è²·å–ã‚’ã”å¸Œæœ›ã®å ´åˆã¯ã€ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ãŠç”³ã—è¾¼ã¿ãã ã•ã„ã€‚</textarea>
                    </div>
                    <button class="btn btn-primary" onclick="sendBuybackInvitation()">æ¡ˆå†…ãƒ¡ãƒ¼ãƒ«é€ä¿¡</button>
                    <button class="btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            `);
        }

        async function sendBuybackInvitation() {
            const applicationId = document.getElementById('progressCustomerSelect').value;
            const message = document.getElementById('buybackMessage').value;

            showNotification('è²·å–æ¡ˆå†…ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
            closeModal();
        }

        // æ–°è¦ãƒ—ãƒ©ãƒ³ä½œæˆãƒ•ã‚©ãƒ¼ãƒ 
        function showProgressPlanForm() {
            showModal('æ–°è¦ä»£è¡Œãƒ—ãƒ©ãƒ³ä½œæˆ', `
                <div class="form-group">
                    <label>æ—¥ä»˜</label>
                    <input type="date" id="newPlanDate" class="form-control">
                </div>
                <div class="form-group">
                    <label>é‘‘å®šã®å›½</label>
                    <select id="newPlanCountry" class="form-control">
                        <option value="usa">ğŸ‡ºğŸ‡¸ ã‚¢ãƒ¡ãƒªã‚«</option>
                        <option value="japan">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ãƒ—ãƒ©ãƒ³ã‚¿ã‚¤ãƒ—</label>
                    <select id="newPlanType" class="form-control">
                        <option value="value-bulk">ãƒãƒªãƒ¥ãƒ¼ãƒãƒ«ã‚¯</option>
                        <option value="economy">ã‚¨ã‚³ãƒãƒŸãƒ¼</option>
                        <option value="standard">ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰</option>
                        <option value="express">ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ã‚¹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¯¾è±¡é¡§å®¢</label>
                    <select id="newPlanCustomers" class="form-control" multiple size="5">
                        ${currentData.applications.map(app =>
                            `<option value="${app.id}">${app.customerName}</option>`
                        ).join('')}
                    </select>
                    <small>è¤‡æ•°é¸æŠå¯ï¼ˆCtrlã‚­ãƒ¼ã‚’æŠ¼ã—ãªãŒã‚‰ã‚¯ãƒªãƒƒã‚¯ï¼‰</small>
                </div>
                <button class="btn btn-primary" onclick="createProgressPlan()">ä½œæˆ</button>
                <button class="btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            `);
        }

        async function createProgressPlan() {
            const planDate = document.getElementById('newPlanDate').value;
            const country = document.getElementById('newPlanCountry').value;
            const planType = document.getElementById('newPlanType').value;
            const selectedOptions = document.getElementById('newPlanCustomers').selectedOptions;
            const customers = Array.from(selectedOptions).map(opt => opt.value);

            if (!planDate || customers.length === 0) {
                showNotification('æ—¥ä»˜ã¨é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            // å„é¡§å®¢ã«å¯¾ã—ã¦é€²æ—ã‚’ä½œæˆ
            for (const customerId of customers) {
                try {
                    const response = await fetch('/api/progress', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            applicationId: customerId,
                            planDate: planDate,
                            country: country,
                            planType: planType,
                            customers: customers
                        })
                    });

                    const data = await response.json();
                    if (!data.success) {
                        console.error('Failed to create progress for', customerId);
                    }
                } catch (error) {
                    console.error('Error creating progress:', error);
                }
            }

            showNotification('ä»£è¡Œãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
            closeModal();
            loadProgress();
        }


        // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºé–¢æ•°
        function showApplicationForm() {
            showModal('æ–°è¦ç”³è¾¼è¿½åŠ ', `
                <div class="form-group">
                    <label>é¡§å®¢å</label>
                    <input type="text" id="newAppCustomerName">
                </div>
                <div class="form-group">
                    <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="newAppCustomerEmail">
                </div>
                <div class="form-group">
                    <label>ç”³è¾¼å†…å®¹</label>
                    <textarea id="newAppContent" rows="4"></textarea>
                </div>
                <button class="btn btn-primary" onclick="createApplication()">ä½œæˆ</button>
                <button class="btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            `);
        }

        function showMessageForm() {
            showModal('æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', `
                <div class="form-group">
                    <label>å®›å…ˆ</label>
                    <select id="newMessageTo">
                        ${currentData.applications.map(app =>
                            `<option value="${app.id}">${app.customerName} - ${app.customerEmail}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
                    <textarea id="newMessageContent" rows="6"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="newMessageSendEmail"> ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡
                    </label>
                </div>
                <button class="btn btn-primary" onclick="sendMessage()">é€ä¿¡</button>
                <button class="btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            `);
        }

        function showApprovalForm() {
            showModal('æ–°è¦æ‰¿èªç”³è«‹', `
                <div class="form-group">
                    <label>é¡§å®¢å</label>
                    <input type="text" id="newApprovalCustomerName">
                </div>
                <div class="form-group">
                    <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="newApprovalCustomerEmail">
                </div>
                <div class="form-group">
                    <label>ã‚«ãƒ¼ãƒ‰å</label>
                    <input type="text" id="newApprovalCardName">
                </div>
                <div class="form-group">
                    <label>è²·å–ä¾¡æ ¼</label>
                    <input type="number" id="newApprovalPrice">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="newApprovalSendEmail" checked> ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡
                    </label>
                </div>
                <button class="btn btn-primary" onclick="createApproval()">ä½œæˆ</button>
                <button class="btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            `);
        }

        // APIä½œæˆé–¢æ•°
        async function createApplication() {
            const applicationData = {
                customerName: document.getElementById('newAppCustomerName').value,
                customerEmail: document.getElementById('newAppCustomerEmail').value,
                content: document.getElementById('newAppContent').value
            };

            try {
                const response = await fetch('/api/applications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(applicationData)
                });

                const data = await response.json();
                if (data.success) {
                    closeModal();
                    loadApplications();
                    loadStatistics();
                }
            } catch (error) {
                showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        async function sendMessage() {
            const messageData = {
                to: document.getElementById('newMessageTo').value,
                message: document.getElementById('newMessageContent').value,
                sendEmail: document.getElementById('newMessageSendEmail').checked,
                toEmail: currentData.applications.find(a => a.id === document.getElementById('newMessageTo').value)?.customerEmail
            };

            try {
                const response = await fetch('/api/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(messageData)
                });

                const data = await response.json();
                if (data.success) {
                    closeModal();
                    loadMessages();
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function createApproval() {
            const approvalData = {
                customerName: document.getElementById('newApprovalCustomerName').value,
                customerEmail: document.getElementById('newApprovalCustomerEmail').value,
                cards: [{
                    name: document.getElementById('newApprovalCardName').value,
                    price: parseFloat(document.getElementById('newApprovalPrice').value)
                }],
                totalPrice: parseFloat(document.getElementById('newApprovalPrice').value),
                sendEmail: document.getElementById('newApprovalSendEmail').checked
            };

            try {
                const response = await fetch('/api/approvals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(approvalData)
                });

                const data = await response.json();
                if (data.success) {
                    closeModal();
                    loadApprovals();
                    loadStatistics();
                }
            } catch (error) {
                showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãã®ä»–ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        async function markAsRead(messageId) {
            try {
                const response = await fetch(`/api/messages/${messageId}/read`, {
                    method: 'PUT'
                });

                const data = await response.json();
                if (data.success) {
                    loadMessages();
                    loadStatistics();
                }
            } catch (error) {
                showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        function viewApplication(id) {
            const app = currentData.applications.find(a => a.id === id);
            if (app) {
                showModal('ç”³è¾¼è©³ç´°', `
                    <div class="form-group">
                        <label>ç”³è¾¼ID</label>
                        <div>${app.id}</div>
                    </div>
                    <div class="form-group">
                        <label>é¡§å®¢å</label>
                        <div>${app.customerName}</div>
                    </div>
                    <div class="form-group">
                        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <div>${app.customerEmail}</div>
                    </div>
                    <div class="form-group">
                        <label>ç”³è¾¼æ—¥æ™‚</label>
                        <div>${new Date(app.createdAt).toLocaleString('ja-JP')}</div>
                    </div>
                    <div class="form-group">
                        <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                        <div><span class="status status-${app.status}">${getStatusLabel(app.status)}</span></div>
                    </div>
                    <button class="btn" onclick="closeModal()">é–‰ã˜ã‚‹</button>
                `);
            }
        }

        function viewMessage(id) {
            const msg = currentData.messages.find(m => m.id === id);
            if (msg) {
                showModal('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è©³ç´°', `
                    <div class="form-group">
                        <label>é€ä¿¡æ—¥æ™‚</label>
                        <div>${new Date(msg.createdAt).toLocaleString('ja-JP')}</div>
                    </div>
                    <div class="form-group">
                        <label>é€ä¿¡è€…</label>
                        <div>${msg.from}</div>
                    </div>
                    <div class="form-group">
                        <label>å®›å…ˆ</label>
                        <div>${msg.to}</div>
                    </div>
                    <div class="form-group">
                        <label>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
                        <div style="white-space: pre-wrap;">${msg.message}</div>
                    </div>
                    <button class="btn" onclick="closeModal()">é–‰ã˜ã‚‹</button>
                `);
                if (!msg.read) {
                    markAsRead(id);
                }
            }
        }

        function viewApproval(id) {
            const approval = currentData.approvals.find(a => a.id === id);
            if (approval) {
                showModal('æ‰¿èªè©³ç´°', `
                    <div class="form-group">
                        <label>æ‰¿èªã‚­ãƒ¼</label>
                        <div style="font-family: monospace; font-size: 18px;">${approval.approvalKey}</div>
                    </div>
                    <div class="form-group">
                        <label>é¡§å®¢å</label>
                        <div>${approval.customerName}</div>
                    </div>
                    <div class="form-group">
                        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <div>${approval.customerEmail}</div>
                    </div>
                    <div class="form-group">
                        <label>ç·é¡</label>
                        <div>Â¥${(approval.totalPrice || 0).toLocaleString()}</div>
                    </div>
                    <div class="form-group">
                        <label>ç”³è«‹æ—¥æ™‚</label>
                        <div>${new Date(approval.createdAt).toLocaleString('ja-JP')}</div>
                    </div>
                    <div class="form-group">
                        <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                        <div><span class="status status-${approval.status}">${getStatusLabel(approval.status)}</span></div>
                    </div>
                    <div class="form-group">
                        <label>æ‰¿èªURL</label>
                        <div style="word-break: break-all;">
                            <a href="https://kanucard-daiko-support.onrender.com/approval/${approval.approvalKey}" target="_blank">
                                https://kanucard-daiko-support.onrender.com/approval/${approval.approvalKey}
                            </a>
                        </div>
                    </div>
                    <button class="btn" onclick="closeModal()">é–‰ã˜ã‚‹</button>
                `);
            }
        }

        async function deleteApplication(id) {
            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/applications/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    loadApplications();
                    loadStatistics();
                }
            } catch (error) {
                showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // Shopifyé¡§å®¢ãƒ‡ãƒ¼ã‚¿ç®¡ç†
        let allShopifyCustomers = [];
        let filteredShopifyCustomers = [];
        let currentShopifySort = 'name';
        const SHOPIFY_CACHE_KEY = 'shopify_customers_cache';
        const SHOPIFY_CACHE_DURATION = 5 * 60 * 1000; // 5åˆ†

        // Shopifyé¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadShopifyCustomers(showLoader = true) {
            if (showLoader) {
                document.getElementById('shopifyCustomersTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="sr-only">èª­ã¿è¾¼ã¿ä¸­...</span>
                            </div>
                            é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
                        </td>
                    </tr>
                `;
            }

            try {
                const token = localStorage.getItem('kanucard_admin_token');
                const response = await fetch('/api/shopify/customers', {
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : '',
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                if (data.success && data.data) {
                    allShopifyCustomers = data.data.customers || [];
                    filteredShopifyCustomers = [...allShopifyCustomers];

                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
                    localStorage.setItem(SHOPIFY_CACHE_KEY, JSON.stringify({
                        customers: allShopifyCustomers,
                        timestamp: Date.now()
                    }));

                    updateShopifyStats();
                    renderShopifyTable();
                } else {
                    throw new Error(data.message || 'é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Shopifyé¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('shopifyCustomersTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-danger">
                            é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ
                        </td>
                    </tr>
                `;
            }
        }

        // Shopifyçµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateShopifyStats() {
            document.getElementById('totalShopifyCustomers').textContent = allShopifyCustomers.length.toLocaleString();

            const totalOrders = allShopifyCustomers.reduce((sum, c) => sum + (c.ordersCount || 0), 0);
            document.getElementById('totalShopifyOrders').textContent = totalOrders.toLocaleString();

            const totalRevenue = allShopifyCustomers.reduce((sum, c) => sum + (parseFloat(c.totalSpent) || 0), 0);
            document.getElementById('totalShopifyRevenue').textContent = 'Â¥' + Math.floor(totalRevenue).toLocaleString();

            const activeCustomers = allShopifyCustomers.filter(c => c.ordersCount > 0).length;
            document.getElementById('activeShopifyCustomers').textContent = activeCustomers.toLocaleString();
        }

        // Shopifyãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderShopifyTable() {
            const tbody = document.getElementById('shopifyCustomersTableBody');

            if (filteredShopifyCustomers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredShopifyCustomers.map(customer => `
                <tr>
                    <td><strong>${customer.fullName || '-'}</strong></td>
                    <td>
                        <a href="mailto:${customer.email}" style="color: #667eea;">
                            ${customer.email || '-'}
                        </a>
                    </td>
                    <td>${customer.phone || '-'}</td>
                    <td>${customer.ordersCount || 0}</td>
                    <td>Â¥${parseFloat(customer.totalSpent || 0).toLocaleString()}</td>
                    <td>${customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('ja-JP') : '-'}</td>
                    <td>
                        <span class="badge ${customer.state === 'enabled' ? 'badge-success' : 'badge-secondary'}">
                            ${customer.state === 'enabled' ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'ç„¡åŠ¹'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewShopifyCustomerDetail('${customer.id}', '${(customer.email || '').replace(/'/g, "\\'")}')">
                            è©³ç´°
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Shopifyé¡§å®¢æ¤œç´¢
        function handleShopifySearch() {
            const query = document.getElementById('shopifySearchInput').value.toLowerCase();

            if (!query) {
                filteredShopifyCustomers = [...allShopifyCustomers];
            } else {
                filteredShopifyCustomers = allShopifyCustomers.filter(customer => {
                    const name = (customer.fullName || '').toLowerCase();
                    const email = (customer.email || '').toLowerCase();
                    return name.includes(query) || email.includes(query);
                });
            }

            renderShopifyTable();
        }

        // Shopifyé¡§å®¢ã‚½ãƒ¼ãƒˆ
        function handleShopifySort() {
            const sortBy = document.getElementById('shopifySortSelect').value;
            currentShopifySort = sortBy;

            filteredShopifyCustomers.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return (a.fullName || '').localeCompare(b.fullName || '');
                    case 'email':
                        return (a.email || '').localeCompare(b.email || '');
                    case 'orders':
                        return (b.ordersCount || 0) - (a.ordersCount || 0);
                    case 'spent':
                        return (parseFloat(b.totalSpent) || 0) - (parseFloat(a.totalSpent) || 0);
                    case 'date':
                        return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                    default:
                        return 0;
                }
            });

            renderShopifyTable();
        }

        // Shopifyé¡§å®¢è©³ç´°è¡¨ç¤º
        async function viewShopifyCustomerDetail(customerId, email) {
            // ã¾ãšç°¡æ˜“çš„ãªãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            openModal('é¡§å®¢è©³ç´°', `
                <div style="text-align: center; padding: 2rem;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">èª­ã¿è¾¼ã¿ä¸­...</span>
                    </div>
                    <p style="margin-top: 1rem;">é¡§å®¢æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
                </div>
            `);

            try {
                // é¡§å®¢ã®è©³ç´°æƒ…å ±ã‚’å–å¾—
                const token = localStorage.getItem('kanucard_admin_token');
                const response = await fetch(`/api/shopify/customer?id=${customerId}`, {
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : '',
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                if (data.success && data.data) {
                    const customer = data.data.customer;
                    const orders = data.data.orders || [];

                    // è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
                    const modalContent = `
                        <div style="max-height: 70vh; overflow-y: auto;">
                            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                            <div class="nav nav-tabs" id="customerDetailTabs" role="tablist">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#basicInfo" type="button">
                                    åŸºæœ¬æƒ…å ±
                                </button>
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#orderHistory" type="button">
                                    æ³¨æ–‡å±¥æ­´
                                </button>
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#addressInfo" type="button">
                                    ä½æ‰€æƒ…å ±
                                </button>
                            </div>

                            <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                            <div class="tab-content" style="padding: 1.5rem;">
                                <!-- åŸºæœ¬æƒ…å ±ã‚¿ãƒ– -->
                                <div class="tab-pane fade show active" id="basicInfo" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5 style="color: #667eea; margin-bottom: 1rem;">é¡§å®¢æƒ…å ±</h5>
                                            <table class="table table-borderless">
                                                <tr>
                                                    <th style="width: 40%;">é¡§å®¢ID:</th>
                                                    <td>${customer.id || '-'}</td>
                                                </tr>
                                                <tr>
                                                    <th>æ°å:</th>
                                                    <td><strong>${customer.first_name || ''} ${customer.last_name || ''}</strong></td>
                                                </tr>
                                                <tr>
                                                    <th>ãƒ¡ãƒ¼ãƒ«:</th>
                                                    <td>
                                                        <a href="mailto:${customer.email}" style="color: #667eea;">
                                                            ${customer.email || '-'}
                                                        </a>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>é›»è©±ç•ªå·:</th>
                                                    <td>${customer.phone || '-'}</td>
                                                </tr>
                                                <tr>
                                                    <th>ç™»éŒ²æ—¥:</th>
                                                    <td>${customer.created_at ? new Date(customer.created_at).toLocaleString('ja-JP') : '-'}</td>
                                                </tr>
                                                <tr>
                                                    <th>æœ€çµ‚æ›´æ–°:</th>
                                                    <td>${customer.updated_at ? new Date(customer.updated_at).toLocaleString('ja-JP') : '-'}</td>
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <h5 style="color: #667eea; margin-bottom: 1rem;">è³¼å…¥çµ±è¨ˆ</h5>
                                            <table class="table table-borderless">
                                                <tr>
                                                    <th style="width: 40%;">æ³¨æ–‡å›æ•°:</th>
                                                    <td><span class="badge badge-primary">${customer.orders_count || 0}å›</span></td>
                                                </tr>
                                                <tr>
                                                    <th>ç·è³¼å…¥é¡:</th>
                                                    <td><strong style="color: #fb923c;">Â¥${parseFloat(customer.total_spent || 0).toLocaleString()}</strong></td>
                                                </tr>
                                                <tr>
                                                    <th>å¹³å‡è³¼å…¥é¡:</th>
                                                    <td>Â¥${customer.orders_count > 0 ? Math.floor(parseFloat(customer.total_spent || 0) / customer.orders_count).toLocaleString() : 0}</td>
                                                </tr>
                                                <tr>
                                                    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</th>
                                                    <td>
                                                        <span class="badge ${customer.state === 'enabled' ? 'badge-success' : 'badge-secondary'}">
                                                            ${customer.state === 'enabled' ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'ç„¡åŠ¹'}
                                                        </span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>ãƒ¡ãƒ¼ãƒ«è³¼èª­:</th>
                                                    <td>
                                                        <span class="badge ${customer.accepts_marketing ? 'badge-success' : 'badge-secondary'}">
                                                            ${customer.accepts_marketing ? 'è³¼èª­ä¸­' : 'æœªè³¼èª­'}
                                                        </span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>ã‚¿ã‚°:</th>
                                                    <td>${customer.tags ? customer.tags.split(',').map(tag => `<span class="badge badge-info" style="margin-right: 4px;">${tag.trim()}</span>`).join('') : '-'}</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                    ${customer.note ? `
                                        <div style="margin-top: 1rem;">
                                            <h5 style="color: #667eea;">å‚™è€ƒ</h5>
                                            <div class="alert alert-info">${customer.note}</div>
                                        </div>
                                    ` : ''}
                                </div>

                                <!-- æ³¨æ–‡å±¥æ­´ã‚¿ãƒ– -->
                                <div class="tab-pane fade" id="orderHistory" role="tabpanel">
                                    <h5 style="color: #667eea; margin-bottom: 1rem;">æ³¨æ–‡å±¥æ­´ï¼ˆæœ€æ–°${orders.length}ä»¶ï¼‰</h5>
                                    ${orders.length > 0 ? `
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead style="background: #f8f9fa;">
                                                    <tr>
                                                        <th>æ³¨æ–‡ç•ªå·</th>
                                                        <th>æ—¥æ™‚</th>
                                                        <th>å•†å“æ•°</th>
                                                        <th>é‡‘é¡</th>
                                                        <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                                        <th>é…é€çŠ¶æ³</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${orders.map(order => `
                                                        <tr>
                                                            <td>
                                                                <a href="#" style="color: #667eea;">
                                                                    #${order.order_number || order.id}
                                                                </a>
                                                            </td>
                                                            <td>${new Date(order.created_at).toLocaleDateString('ja-JP')}</td>
                                                            <td>${order.line_items ? order.line_items.length : 0}ç‚¹</td>
                                                            <td><strong>Â¥${parseFloat(order.total_price || 0).toLocaleString()}</strong></td>
                                                            <td>
                                                                <span class="badge badge-${order.financial_status === 'paid' ? 'success' : 'warning'}">
                                                                    ${order.financial_status === 'paid' ? 'æ”¯æ‰•æ¸ˆ' : order.financial_status || 'æœªæ‰•ã„'}
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <span class="badge badge-${order.fulfillment_status ? 'success' : 'secondary'}">
                                                                    ${order.fulfillment_status === 'fulfilled' ? 'ç™ºé€æ¸ˆ' : order.fulfillment_status || 'æœªç™ºé€'}
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    ` : `
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> æ³¨æ–‡å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“
                                        </div>
                                    `}
                                </div>

                                <!-- ä½æ‰€æƒ…å ±ã‚¿ãƒ– -->
                                <div class="tab-pane fade" id="addressInfo" role="tabpanel">
                                    <h5 style="color: #667eea; margin-bottom: 1rem;">é…é€å…ˆä½æ‰€</h5>
                                    ${customer.addresses && customer.addresses.length > 0 ? `
                                        <div class="row">
                                            ${customer.addresses.map((addr, index) => `
                                                <div class="col-md-6 mb-3">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            ä½æ‰€ ${index + 1}
                                                            ${addr.default ? '<span class="badge badge-primary float-right">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</span>' : ''}
                                                        </div>
                                                        <div class="card-body">
                                                            <p><strong>${addr.first_name || ''} ${addr.last_name || ''}</strong></p>
                                                            ${addr.company ? `<p>${addr.company}</p>` : ''}
                                                            <p>ã€’${addr.zip || ''}</p>
                                                            <p>${addr.province || ''} ${addr.city || ''}</p>
                                                            <p>${addr.address1 || ''}</p>
                                                            ${addr.address2 ? `<p>${addr.address2}</p>` : ''}
                                                            ${addr.phone ? `<p>é›»è©±: ${addr.phone}</p>` : ''}
                                                            <p>å›½: ${addr.country || ''}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> ç™»éŒ²ã•ã‚ŒãŸä½æ‰€ã¯ã‚ã‚Šã¾ã›ã‚“
                                        </div>
                                    `}
                                </div>
                            </div>

                            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                            <div style="border-top: 1px solid #dee2e6; padding-top: 1rem; margin-top: 1rem;">
                                <div class="row">
                                    <div class="col-6">
                                        <a href="/customer-detail.html?id=${customerId}" target="_blank" class="btn btn-outline-primary btn-block">
                                            <i class="fas fa-external-link-alt"></i> åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã
                                        </a>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-secondary btn-block" onclick="closeModal()">
                                            é–‰ã˜ã‚‹
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã‚’æ›´æ–°
                    document.getElementById('modalTitle').textContent = `é¡§å®¢è©³ç´° - ${customer.first_name || ''} ${customer.last_name || ''}`;
                    document.getElementById('modalBody').innerHTML = modalContent;

                    // ã‚¿ãƒ–æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ï¼ˆBootstrapé¢¨ã®å®Ÿè£…ï¼‰
                    setupCustomerDetailTabs();
                } else {
                    throw new Error(data.message || 'é¡§å®¢æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('é¡§å®¢è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('modalBody').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        é¡§å®¢æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ<br>
                        ${error.message}
                    </div>
                    <div style="text-align: center; margin-top: 1rem;">
                        <button class="btn btn-secondary" onclick="closeModal()">é–‰ã˜ã‚‹</button>
                    </div>
                `;
            }
        }

        // ã‚¿ãƒ–æ©Ÿèƒ½ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupCustomerDetailTabs() {
            const tabButtons = document.querySelectorAll('#customerDetailTabs button');
            const tabPanes = document.querySelectorAll('.tab-pane');

            tabButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();

                    // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã¨ãƒšã‚¤ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanes.forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });

                    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                    button.classList.add('active');
                    const targetId = button.getAttribute('data-bs-target');
                    const targetPane = document.querySelector(targetId);
                    if (targetPane) {
                        targetPane.classList.add('show', 'active');
                    }
                });
            });
        }

        // Shopifyé¡§å®¢ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        function refreshCustomers() {
            loadShopifyCustomers(true);
        }

        // é¡§å®¢ã®Shopifyå±¥æ­´ã‚’è¡¨ç¤º
        function viewCustomerHistory(email) {
            if (!email) {
                alert('é¡§å®¢ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            viewShopifyCustomerDetail('', email);
        }

        // ç”»é¢å¤–ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // ========== ãƒ•ã‚©ãƒ¼ãƒ ç”³è«‹ç®¡ç†æ©Ÿèƒ½ ==========

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let allSubmissions = [];
        let filteredSubmissions = [];

        // ãƒ•ã‚©ãƒ¼ãƒ ç”³è«‹ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadFormSubmissions() {
            try {
                const response = await apiClient.get('/api/admin/form-submissions');

                if (response.success) {
                    allSubmissions = response.data || [];
                    filteredSubmissions = [...allSubmissions];
                    displaySubmissions(filteredSubmissions);
                } else {
                    throw new Error(response.error || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('ãƒ•ã‚©ãƒ¼ãƒ ç”³è«‹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('submissionsTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 2rem; color: #e74c3c;">
                            <i class="fas fa-exclamation-triangle"></i> ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // ç”³è«‹ã‚’è¡¨ç¤º
        function displaySubmissions(submissions) {
            const tbody = document.getElementById('submissionsTableBody');

            if (!submissions || submissions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 2rem; color: #999;">
                            ç”³è«‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = submissions.map(submission => {
                const statusBadge = getStatusBadge(submission.status);
                const country = submission.country === 'japan' ? 'æ—¥æœ¬' : submission.country === 'usa' ? 'ã‚¢ãƒ¡ãƒªã‚«' : submission.country || '-';
                const planType = submission.plan_type === 'normal' ? 'ãƒãƒ¼ãƒãƒ«' : submission.plan_type === 'guarantee' ? '70%ä¿è¨¼' : submission.plan_type || '-';
                const plan = `${country} ${planType}`;
                const itemCount = submission.cards ? submission.cards.length : 0;
                const createdDate = new Date(submission.created_at).toLocaleString('ja-JP');

                return `
                    <tr>
                        <td style="font-family: monospace;">${submission.id.substring(0, 8)}...</td>
                        <td>${submission.user ? submission.user.name || '-' : '-'}</td>
                        <td>${submission.user ? submission.user.email || '-' : '-'}</td>
                        <td>${plan}</td>
                        <td>${itemCount}</td>
                        <td>${statusBadge}</td>
                        <td>${createdDate}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewSubmissionDetail('${submission.id}')">
                                è©³ç´°
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ã‚’å–å¾—
        function getStatusBadge(status) {
            const statusMap = {
                'pending': { label: 'ä¿ç•™ä¸­', class: 'warning' },
                'processing': { label: 'å‡¦ç†ä¸­', class: 'info' },
                'completed': { label: 'å®Œäº†', class: 'success' },
                'cancelled': { label: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', class: 'danger' }
            };

            const statusInfo = statusMap[status] || { label: status || 'ä¸æ˜', class: 'secondary' };
            return `<span class="badge badge-${statusInfo.class}">${statusInfo.label}</span>`;
        }

        // ç”³è«‹ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        function filterSubmissions() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchSubmissions').value.toLowerCase();

            filteredSubmissions = allSubmissions.filter(submission => {
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                if (statusFilter && submission.status !== statusFilter) {
                    return false;
                }

                // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                if (searchTerm) {
                    const userName = submission.user?.name?.toLowerCase() || '';
                    const userEmail = submission.user?.email?.toLowerCase() || '';
                    if (!userName.includes(searchTerm) && !userEmail.includes(searchTerm)) {
                        return false;
                    }
                }

                return true;
            });

            displaySubmissions(filteredSubmissions);
        }

        // ç”³è«‹è©³ç´°ã‚’è¡¨ç¤º
        async function viewSubmissionDetail(submissionId) {
            try {
                const response = await apiClient.get(`/api/admin/form-submission/${submissionId}`);

                if (response.success) {
                    const submission = response.data;
                    showSubmissionDetailModal(submission);
                } else {
                    throw new Error(response.error || 'è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('ç”³è«‹è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                alert('ç”³è«‹è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ç”³è«‹è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showSubmissionDetailModal(submission) {
            const modal = document.getElementById('submissionDetailModal');
            const modalTitle = document.getElementById('submissionModalTitle');
            const modalBody = document.getElementById('submissionModalBody');

            const country = submission.country === 'japan' ? 'æ—¥æœ¬' : submission.country === 'usa' ? 'ã‚¢ãƒ¡ãƒªã‚«' : submission.country || '-';
            const planType = submission.plan_type === 'normal' ? 'ãƒãƒ¼ãƒãƒ«' : submission.plan_type === 'guarantee' ? '70%ä¿è¨¼' : submission.plan_type || '-';
            const plan = `${country} ${planType}`;

            modalTitle.textContent = `ç”³è«‹è©³ç´° - ${submission.id.substring(0, 12)}`;

            modalBody.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <h4>åŸºæœ¬æƒ…å ±</h4>
                    <table class="table">
                        <tr>
                            <th style="width: 200px;">ç”³è«‹ID</th>
                            <td style="font-family: monospace;">${submission.id}</td>
                        </tr>
                        <tr>
                            <th>é¡§å®¢å</th>
                            <td>${submission.user?.name || '-'}</td>
                        </tr>
                        <tr>
                            <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                            <td>${submission.user?.email || '-'}</td>
                        </tr>
                        <tr>
                            <th>é›»è©±ç•ªå·</th>
                            <td>${submission.user?.phone || '-'}</td>
                        </tr>
                        <tr>
                            <th>ãƒ—ãƒ©ãƒ³</th>
                            <td>${plan}</td>
                        </tr>
                        <tr>
                            <th>ã‚µãƒ¼ãƒ“ã‚¹ã‚¿ã‚¤ãƒ—</th>
                            <td>${submission.service_type || 'psa-grading'}</td>
                        </tr>
                        <tr>
                            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                            <td>${getStatusBadge(submission.status)}</td>
                        </tr>
                        <tr>
                            <th>ç”³è«‹æ—¥æ™‚</th>
                            <td>${new Date(submission.created_at).toLocaleString('ja-JP')}</td>
                        </tr>
                        <tr>
                            <th>æ›´æ–°æ—¥æ™‚</th>
                            <td>${new Date(submission.updated_at).toLocaleString('ja-JP')}</td>
                        </tr>
                    </table>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h4>ã‚«ãƒ¼ãƒ‰æƒ…å ± (${submission.cards?.length || 0}ä»¶)</h4>
                    ${submission.cards && submission.cards.length > 0 ? `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ã‚«ãƒ¼ãƒ‰å</th>
                                    <th>ç”³å‘Šä¾¡å€¤</th>
                                    <th>é‘‘å®šæ–™è¦‹ç©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${submission.cards.map(card => `
                                    <tr>
                                        <td>${card.card_name}</td>
                                        <td>Â¥${(card.declared_value || 0).toLocaleString()}</td>
                                        <td>Â¥${(card.estimated_grading_fee || 0).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p>ã‚«ãƒ¼ãƒ‰æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>'}
                </div>

                ${submission.customer_notes ? `
                    <div style="margin-bottom: 2rem;">
                        <h4>é¡§å®¢ãƒ¡ãƒ¢</h4>
                        <p style="white-space: pre-wrap; background: #f8f9fa; padding: 1rem; border-radius: 4px;">${submission.customer_notes}</p>
                    </div>
                ` : ''}

                ${submission.admin_notes ? `
                    <div style="margin-bottom: 2rem;">
                        <h4>ç®¡ç†è€…ãƒ¡ãƒ¢</h4>
                        <p style="white-space: pre-wrap; background: #fff3cd; padding: 1rem; border-radius: 4px;">${submission.admin_notes}</p>
                    </div>
                ` : ''}

                <div style="margin-bottom: 2rem;">
                    <h4>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´</h4>
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <select id="newStatus" class="form-control" style="max-width: 200px;">
                            <option value="pending" ${submission.status === 'pending' ? 'selected' : ''}>ä¿ç•™ä¸­</option>
                            <option value="processing" ${submission.status === 'processing' ? 'selected' : ''}>å‡¦ç†ä¸­</option>
                            <option value="completed" ${submission.status === 'completed' ? 'selected' : ''}>å®Œäº†</option>
                            <option value="cancelled" ${submission.status === 'cancelled' ? 'selected' : ''}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                        </select>

                        <input type="text" id="adminNotes" class="form-control" placeholder="ç®¡ç†è€…ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰"
                               style="flex: 1; min-width: 300px;">

                        <button class="btn btn-primary" onclick="updateSubmissionStatus('${submission.id}')">
                            <i class="fas fa-save"></i> æ›´æ–°
                        </button>
                    </div>
                </div>

                <div style="text-align: right;">
                    <button class="btn btn-secondary" onclick="closeSubmissionDetailModal()">é–‰ã˜ã‚‹</button>
                </div>
            `;

            modal.style.display = 'block';
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        async function updateSubmissionStatus(submissionId) {
            const newStatus = document.getElementById('newStatus').value;
            const adminNotes = document.getElementById('adminNotes').value;

            if (!confirm('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const response = await apiClient.put(`/api/admin/form-submission/${submissionId}/status`, {
                    status: newStatus,
                    adminNotes: adminNotes || null
                });

                if (response.success) {
                    alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    closeSubmissionDetailModal();
                    loadFormSubmissions(); // ãƒªãƒ­ãƒ¼ãƒ‰
                } else {
                    throw new Error(response.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeSubmissionDetailModal() {
            document.getElementById('submissionDetailModal').style.display = 'none';
        }

        // submissionDetailModalã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('submissionDetailModal');
            if (event.target === modal) {
                closeSubmissionDetailModal();
            }
        });
    </script>
</body>
</html>