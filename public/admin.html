<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSA‰ª£Ë°å„Çµ„Éº„Éì„Çπ Á∑èÂêàÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header-stats {
            display: flex;
            gap: 30px;
            margin-top: 15px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä */
        .main-container {
            display: flex;
            height: calc(100vh - 120px);
        }

        /* „Çµ„Ç§„Éâ„Éê„Éº */
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .nav-item:hover {
            background: #f8f9fa;
        }

        .nav-item.active {
            background: #f0f4ff;
            border-left-color: #667eea;
        }

        .nav-item i {
            width: 20px;
            margin-right: 10px;
        }

        .badge {
            margin-left: auto;
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        /* „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ */
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .content-title {
            font-size: 24px;
            color: #2c3e50;
        }

        /* „Ç´„Éº„Éâ */
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        /* „ÉÜ„Éº„Éñ„É´ */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* „Éú„Çø„É≥ */
        .btn {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* „Éï„Ç©„Éº„É† */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏ */
        .status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* „Çø„Éñ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #f8f9fa;
        }

        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
        }

        /* „Ç∞„É™„ÉÉ„Éâ */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        /* „Çµ„Éº„Éì„ÇπÁä∂Ê≥Å„ÉÜ„Éº„Éñ„É´ */
        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .service-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .service-card.active {
            border-color: #27ae60;
            background: #f0fff4;
        }

        .service-card.inactive {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        /* „Çπ„Ç±„Ç∏„É•„Éº„É´„Ç´„Éº„Éâ */
        .schedule-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .schedule-date {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .schedule-label {
            color: #555;
            font-size: 14px;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .header-stats {
                flex-wrap: wrap;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="header">
        <h1>PSA‰ª£Ë°å„Çµ„Éº„Éì„Çπ Á∑èÂêàÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h1>
        <div class="header-stats">
            <div class="stat-item">
                <span class="stat-value" id="totalApplications">0</span>
                <span class="stat-label">Á∑èÁî≥ËæºÊï∞</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="pendingApprovals">0</span>
                <span class="stat-label">ÊâøË™çÂæÖ„Å°</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="unreadMessages">0</span>
                <span class="stat-label">Êú™Ë™≠„É°„ÉÉ„Çª„Éº„Ç∏</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="nextShipDate">-</span>
                <span class="stat-label">Ê¨°ÂõûÁô∫ÈÄÅÊó•</span>
            </div>
        </div>
    </div>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä -->
    <div class="main-container">
        <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
        <div class="sidebar">
            <div class="nav-item active" onclick="showSection('dashboard')">
                <i>üìä</i>
                <span>„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</span>
            </div>
            <div class="nav-item" onclick="showSection('applications')">
                <i>üìù</i>
                <span>‰ª£Ë°åÁî≥ËæºÁÆ°ÁêÜ</span>
                <span class="badge" id="applicationsBadge" style="display: none;">0</span>
            </div>
            <div class="nav-item" onclick="showSection('progress')">
                <i>üìà</i>
                <span>ÈÄ≤ÊçóÁä∂Ê≥ÅÁÆ°ÁêÜ</span>
            </div>
            <div class="nav-item" onclick="showSection('messages')">
                <i>üí¨</i>
                <span>„É°„ÉÉ„Çª„Éº„Ç∏ÁÆ°ÁêÜ</span>
                <span class="badge" id="messagesBadge" style="display: none;">0</span>
            </div>
            <div class="nav-item" onclick="showSection('approvals')">
                <i>‚úÖ</i>
                <span>Ë≤∑ÂèñÊâøË™çÁÆ°ÁêÜ</span>
                <span class="badge" id="approvalsBadge" style="display: none;">0</span>
            </div>
            <div class="nav-item" onclick="showSection('service')">
                <i>‚öôÔ∏è</i>
                <span>„Çµ„Éº„Éì„ÇπÁä∂Ê≥ÅË®≠ÂÆö</span>
            </div>
            <div class="nav-item" onclick="showSection('schedule')">
                <i>üìÖ</i>
                <span>Áô∫ÈÄÅ„Çπ„Ç±„Ç∏„É•„Éº„É´</span>
            </div>
        </div>

        <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ -->
        <div class="content">
            <!-- „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ -->
            <div id="dashboard-section" class="section">
                <div class="content-header">
                    <h2 class="content-title">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h2>
                </div>

                <div class="grid">
                    <div class="card">
                        <div class="card-title">Êú¨Êó•„ÅÆÁî≥Ëæº</div>
                        <div style="font-size: 32px; font-weight: bold; color: #667eea;">
                            <span id="todayApplications">0</span>‰ª∂
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">Âá¶ÁêÜ‰∏≠</div>
                        <div style="font-size: 32px; font-weight: bold; color: #f39c12;">
                            <span id="inProgress">0</span>‰ª∂
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">ÂÆå‰∫Ü</div>
                        <div style="font-size: 32px; font-weight: bold; color: #27ae60;">
                            <span id="completed">0</span>‰ª∂
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">ÊúÄËøë„ÅÆÁî≥Ëæº</div>
                    <table id="recentApplicationsTable">
                        <thead>
                            <tr>
                                <th>Áî≥ËæºID</th>
                                <th>È°ßÂÆ¢Âêç</th>
                                <th>Áî≥ËæºÊó•ÊôÇ</th>
                                <th>„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="card">
                    <div class="card-title">„Çµ„Éº„Éì„ÇπÁä∂Ê≥Å</div>
                    <div class="service-grid" id="serviceStatusGrid"></div>
                </div>
            </div>

            <!-- ‰ª£Ë°åÁî≥ËæºÁÆ°ÁêÜ -->
            <div id="applications-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">‰ª£Ë°åÁî≥ËæºÁÆ°ÁêÜ</h2>
                    <button class="btn btn-primary" onclick="showApplicationForm()">Êñ∞Ë¶èÁî≥ËæºËøΩÂä†</button>
                </div>

                <div class="card">
                    <table id="applicationsTable">
                        <thead>
                            <tr>
                                <th>Áî≥ËæºID</th>
                                <th>È°ßÂÆ¢Âêç</th>
                                <th>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</th>
                                <th>Áî≥ËæºÊó•ÊôÇ</th>
                                <th>„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- ÈÄ≤ÊçóÁä∂Ê≥ÅÁÆ°ÁêÜ -->
            <div id="progress-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">ÈÄ≤ÊçóÁä∂Ê≥ÅÁÆ°ÁêÜ</h2>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label>Áî≥ËæºÈÅ∏Êäû</label>
                        <select id="progressApplicationSelect" onchange="loadProgressForApplication()">
                            <option value="">Áî≥Ëæº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        </select>
                    </div>

                    <div id="progressTimeline"></div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞</label>
                        <select id="progressStatus">
                            <option value="received">Âèó‰ªòÊ∏à„Åø</option>
                            <option value="preparing">Ê∫ñÂÇô‰∏≠</option>
                            <option value="shipped">Áô∫ÈÄÅÊ∏à„Åø</option>
                            <option value="grading">ÈëëÂÆö‰∏≠</option>
                            <option value="returned">ËøîÈÄÅ‰∏≠</option>
                            <option value="completed">ÂÆå‰∫Ü</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ë™¨Êòé</label>
                        <textarea id="progressDescription"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addProgress()">ÈÄ≤Êçó„ÇíÊõ¥Êñ∞</button>
                </div>
            </div>

            <!-- „É°„ÉÉ„Çª„Éº„Ç∏ÁÆ°ÁêÜ -->
            <div id="messages-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">„É°„ÉÉ„Çª„Éº„Ç∏ÁÆ°ÁêÜ</h2>
                    <button class="btn btn-primary" onclick="showMessageForm()">Êñ∞Ë¶è„É°„ÉÉ„Çª„Éº„Ç∏</button>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="switchMessageTab('inbox')">Âèó‰ø°ÁÆ±</div>
                    <div class="tab" onclick="switchMessageTab('sent')">ÈÄÅ‰ø°Ê∏à„Åø</div>
                </div>

                <div class="card">
                    <table id="messagesTable">
                        <thead>
                            <tr>
                                <th>Êó•ÊôÇ</th>
                                <th>ÈÄÅ‰ø°ËÄÖ</th>
                                <th>ÂÆõÂÖà</th>
                                <th>„É°„ÉÉ„Çª„Éº„Ç∏</th>
                                <th>„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Ë≤∑ÂèñÊâøË™çÁÆ°ÁêÜ -->
            <div id="approvals-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">Ë≤∑ÂèñÊâøË™çÁÆ°ÁêÜ</h2>
                    <button class="btn btn-primary" onclick="showApprovalForm()">Êñ∞Ë¶èÊâøË™çÁî≥Ë´ã</button>
                </div>

                <div class="card">
                    <table id="approvalsTable">
                        <thead>
                            <tr>
                                <th>ÊâøË™ç„Ç≠„Éº</th>
                                <th>È°ßÂÆ¢Âêç</th>
                                <th>Á∑èÈ°ç</th>
                                <th>Áî≥Ë´ãÊó•ÊôÇ</th>
                                <th>„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- „Çµ„Éº„Éì„ÇπÁä∂Ê≥ÅË®≠ÂÆö -->
            <div id="service-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">„Çµ„Éº„Éì„ÇπÁä∂Ê≥ÅË®≠ÂÆö</h2>
                </div>

                <div class="card">
                    <div class="card-title">„Çµ„Éº„Éì„ÇπÁ®ºÂÉçÁä∂Ê≥Å</div>
                    <div class="service-grid" id="serviceManagementGrid"></div>
                </div>

                <div class="card">
                    <div class="card-title">„ÅäÁü•„Çâ„ÅõË®≠ÂÆö</div>
                    <div class="form-group">
                        <label>„ÅäÁü•„Çâ„ÅõÊñáÔºàÂà©Áî®ËÄÖ„Çµ„Ç§„Éà„Å´Ë°®Á§∫„Åï„Çå„Åæ„ÅôÔºâ</label>
                        <textarea id="serviceAnnouncement" rows="4"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="updateServiceStatus()">Êõ¥Êñ∞</button>
                </div>
            </div>

            <!-- Áô∫ÈÄÅ„Çπ„Ç±„Ç∏„É•„Éº„É´ -->
            <div id="schedule-section" class="section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">Áô∫ÈÄÅ„Çπ„Ç±„Ç∏„É•„Éº„É´ÁÆ°ÁêÜ</h2>
                </div>

                <div class="schedule-card">
                    <div class="schedule-date" id="currentNextShipDate">Êú™Ë®≠ÂÆö</div>
                    <div class="schedule-label">ÁèæÂú®„ÅÆÊ¨°ÂõûÁô∫ÈÄÅ‰∫àÂÆöÊó•</div>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label>Ê¨°ÂõûÁô∫ÈÄÅÊó•</label>
                        <input type="date" id="nextShipDate">
                    </div>
                    <div class="form-group">
                        <label>ËøîÈÄÅ‰∫àÂÆöÊó•</label>
                        <input type="date" id="estimatedReturnDate">
                    </div>
                    <div class="form-group">
                        <label>ÂÇôËÄÉ</label>
                        <textarea id="scheduleNotes" rows="4"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="updateSchedule()">„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÊõ¥Êñ∞</button>
                </div>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´ -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">„Çø„Ç§„Éà„É´</h3>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentData = {
            applications: [],
            progress: [],
            messages: [],
            approvals: [],
            serviceStatus: {},
            schedule: {},
            statistics: {}
        };

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            loadStatistics();
            loadAllData();
            setInterval(loadStatistics, 30000); // 30Áßí„Åî„Å®„Å´Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞
        });

        // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        async function loadAllData() {
            await Promise.all([
                loadApplications(),
                loadProgress(),
                loadMessages(),
                loadApprovals(),
                loadServiceStatus(),
                loadSchedule()
            ]);
            updateDashboard();
        }

        async function loadStatistics() {
            try {
                const response = await fetch('/api/statistics');
                const data = await response.json();
                if (data.success) {
                    currentData.statistics = data.data;
                    updateHeaderStats();
                }
            } catch (error) {
                console.error('Failed to load statistics:', error);
            }
        }

        async function loadApplications() {
            try {
                const response = await fetch('/api/applications');
                const data = await response.json();
                if (data.success) {
                    currentData.applications = data.data;
                    updateApplicationsTable();
                }
            } catch (error) {
                console.error('Failed to load applications:', error);
            }
        }

        async function loadProgress() {
            try {
                const response = await fetch('/api/progress');
                const data = await response.json();
                if (data.success) {
                    currentData.progress = data.data;
                }
            } catch (error) {
                console.error('Failed to load progress:', error);
            }
        }

        async function loadMessages() {
            try {
                const response = await fetch('/api/messages');
                const data = await response.json();
                if (data.success) {
                    currentData.messages = data.data;
                    updateMessagesTable();
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }

        async function loadApprovals() {
            try {
                const response = await fetch('/api/approvals');
                const data = await response.json();
                if (data.success) {
                    currentData.approvals = data.data;
                    updateApprovalsTable();
                }
            } catch (error) {
                console.error('Failed to load approvals:', error);
            }
        }

        async function loadServiceStatus() {
            try {
                const response = await fetch('/api/service-status');
                const data = await response.json();
                if (data.success) {
                    currentData.serviceStatus = data.data;
                    updateServiceStatus();
                }
            } catch (error) {
                console.error('Failed to load service status:', error);
            }
        }

        async function loadSchedule() {
            try {
                const response = await fetch('/api/schedule');
                const data = await response.json();
                if (data.success) {
                    currentData.schedule = data.data;
                    updateScheduleDisplay();
                }
            } catch (error) {
                console.error('Failed to load schedule:', error);
            }
        }

        // UIÊõ¥Êñ∞Èñ¢Êï∞
        function updateHeaderStats() {
            const stats = currentData.statistics;
            document.getElementById('totalApplications').textContent = stats.totalApplications || 0;
            document.getElementById('pendingApprovals').textContent = stats.pendingApprovals || 0;
            document.getElementById('unreadMessages').textContent = stats.unreadMessages || 0;
            document.getElementById('nextShipDate').textContent =
                stats.nextShipDate ? new Date(stats.nextShipDate).toLocaleDateString('ja-JP') : '-';

            // „Éê„ÉÉ„Ç∏Êõ¥Êñ∞
            updateBadge('applicationsBadge', stats.pendingApplications);
            updateBadge('messagesBadge', stats.unreadMessages);
            updateBadge('approvalsBadge', stats.pendingApprovals);
        }

        function updateBadge(elementId, count) {
            const badge = document.getElementById(elementId);
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function updateDashboard() {
            const stats = currentData.statistics;
            document.getElementById('todayApplications').textContent =
                currentData.applications.filter(a => {
                    const today = new Date().toDateString();
                    return new Date(a.createdAt).toDateString() === today;
                }).length;

            document.getElementById('inProgress').textContent = stats.inProgressApplications || 0;
            document.getElementById('completed').textContent = stats.completedApplications || 0;

            // ÊúÄËøë„ÅÆÁî≥Ëæº
            const recentApplications = currentData.applications.slice(0, 5);
            const tbody = document.querySelector('#recentApplicationsTable tbody');
            tbody.innerHTML = recentApplications.map(app => `
                <tr>
                    <td>${app.id.substring(0, 8)}</td>
                    <td>${app.customerName || '-'}</td>
                    <td>${new Date(app.createdAt).toLocaleString('ja-JP')}</td>
                    <td><span class="status status-${app.status}">${getStatusLabel(app.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewApplication('${app.id}')">Ë©≥Á¥∞</button>
                    </td>
                </tr>
            `).join('');

            // „Çµ„Éº„Éì„ÇπÁä∂Ê≥Å
            if (currentData.serviceStatus.services) {
                document.getElementById('serviceStatusGrid').innerHTML =
                    currentData.serviceStatus.services.map(service => `
                        <div class="service-card ${service.status}">
                            <div style="font-size: 18px; font-weight: bold;">${service.name}</div>
                            <div style="margin-top: 5px; color: ${service.status === 'active' ? '#27ae60' : '#e74c3c'};">
                                ${service.status === 'active' ? 'Á®ºÂÉç‰∏≠' : 'ÂÅúÊ≠¢‰∏≠'}
                            </div>
                        </div>
                    `).join('');
            }
        }

        function updateApplicationsTable() {
            const tbody = document.querySelector('#applicationsTable tbody');
            tbody.innerHTML = currentData.applications.map(app => `
                <tr>
                    <td>${app.id.substring(0, 8)}</td>
                    <td>${app.customerName || '-'}</td>
                    <td>${app.customerEmail || '-'}</td>
                    <td>${new Date(app.createdAt).toLocaleString('ja-JP')}</td>
                    <td><span class="status status-${app.status}">${getStatusLabel(app.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewApplication('${app.id}')">Ë©≥Á¥∞</button>
                        <button class="btn btn-sm btn-success" onclick="updateApplicationStatus('${app.id}')">Êõ¥Êñ∞</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteApplication('${app.id}')">ÂâäÈô§</button>
                    </td>
                </tr>
            `).join('');

            // ÈÄ≤ÊçóÁÆ°ÁêÜÁî®„ÅÆ„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÇÇÊõ¥Êñ∞
            const select = document.getElementById('progressApplicationSelect');
            if (select) {
                select.innerHTML = '<option value="">Áî≥Ëæº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>' +
                    currentData.applications.map(app =>
                        `<option value="${app.id}">${app.customerName} - ${app.id.substring(0, 8)}</option>`
                    ).join('');
            }
        }

        function updateMessagesTable() {
            const tbody = document.querySelector('#messagesTable tbody');
            tbody.innerHTML = currentData.messages.map(msg => `
                <tr>
                    <td>${new Date(msg.createdAt).toLocaleString('ja-JP')}</td>
                    <td>${msg.from}</td>
                    <td>${msg.to}</td>
                    <td>${msg.message.substring(0, 50)}${msg.message.length > 50 ? '...' : ''}</td>
                    <td>${msg.read ? 'Êó¢Ë™≠' : '<strong>Êú™Ë™≠</strong>'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewMessage('${msg.id}')">Ë©≥Á¥∞</button>
                        ${!msg.read ? `<button class="btn btn-sm btn-success" onclick="markAsRead('${msg.id}')">Êó¢Ë™≠</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function updateApprovalsTable() {
            const tbody = document.querySelector('#approvalsTable tbody');
            tbody.innerHTML = currentData.approvals.map(approval => `
                <tr>
                    <td>${approval.approvalKey}</td>
                    <td>${approval.customerName}</td>
                    <td>¬•${(approval.totalPrice || 0).toLocaleString()}</td>
                    <td>${new Date(approval.createdAt).toLocaleString('ja-JP')}</td>
                    <td><span class="status status-${approval.status}">${getStatusLabel(approval.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewApproval('${approval.id}')">Ë©≥Á¥∞</button>
                        <button class="btn btn-sm btn-warning" onclick="resendApprovalEmail('${approval.id}')">ÂÜçÈÄÅ‰ø°</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateServiceStatus() {
            if (currentData.serviceStatus.services) {
                document.getElementById('serviceManagementGrid').innerHTML =
                    currentData.serviceStatus.services.map(service => `
                        <div class="service-card ${service.status}" onclick="toggleService('${service.id}')">
                            <div style="font-size: 18px; font-weight: bold;">${service.name}</div>
                            <div style="margin-top: 5px;">
                                ${service.status === 'active' ? '‚úÖ Á®ºÂÉç‰∏≠' : '‚ùå ÂÅúÊ≠¢‰∏≠'}
                            </div>
                            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                „ÇØ„É™„ÉÉ„ÇØ„ÅßÂàá„ÇäÊõø„Åà
                            </div>
                        </div>
                    `).join('');

                document.getElementById('serviceAnnouncement').value =
                    currentData.serviceStatus.announcement || '';
            }
        }

        function updateScheduleDisplay() {
            if (currentData.schedule.nextShipDate) {
                document.getElementById('currentNextShipDate').textContent =
                    new Date(currentData.schedule.nextShipDate).toLocaleDateString('ja-JP');
                document.getElementById('nextShipDate').value =
                    currentData.schedule.nextShipDate.split('T')[0];
            }
            if (currentData.schedule.estimatedReturnDate) {
                document.getElementById('estimatedReturnDate').value =
                    currentData.schedule.estimatedReturnDate.split('T')[0];
            }
            if (currentData.schedule.notes) {
                document.getElementById('scheduleNotes').value = currentData.schedule.notes;
            }
        }

        // „Çª„ÇØ„Ç∑„Éß„É≥Ë°®Á§∫Âàá„ÇäÊõø„Åà
        function showSection(sectionName) {
            // „Åô„Åπ„Å¶„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });

            // ÈÅ∏Êäû„Åï„Çå„Åü„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
            document.getElementById(`${sectionName}-section`).style.display = 'block';

            // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');

            // „Éá„Éº„Çø„ÇíÊõ¥Êñ∞
            if (sectionName === 'dashboard') {
                updateDashboard();
            }
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„É©„Éô„É´ÂèñÂæó
        function getStatusLabel(status) {
            const labels = {
                'pending': '‰øùÁïô‰∏≠',
                'in_progress': 'Âá¶ÁêÜ‰∏≠',
                'completed': 'ÂÆå‰∫Ü',
                'approved': 'ÊâøË™çÊ∏à„Åø',
                'rejected': 'ÊãíÂê¶',
                'active': 'Á®ºÂÉç‰∏≠',
                'inactive': 'ÂÅúÊ≠¢‰∏≠'
            };
            return labels[status] || status;
        }

        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // APIÂëº„Å≥Âá∫„ÅóÈñ¢Êï∞
        async function updateSchedule() {
            const scheduleData = {
                nextShipDate: document.getElementById('nextShipDate').value,
                estimatedReturnDate: document.getElementById('estimatedReturnDate').value,
                notes: document.getElementById('scheduleNotes').value
            };

            try {
                const response = await fetch('/api/schedule', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(scheduleData)
                });

                const data = await response.json();
                if (data.success) {
                    alert('„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                    loadSchedule();
                    loadStatistics();
                }
            } catch (error) {
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            }
        }

        async function toggleService(serviceId) {
            const service = currentData.serviceStatus.services.find(s => s.id === serviceId);
            if (service) {
                service.status = service.status === 'active' ? 'inactive' : 'active';

                try {
                    const response = await fetch('/api/service-status', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(currentData.serviceStatus)
                    });

                    const data = await response.json();
                    if (data.success) {
                        loadServiceStatus();
                    }
                } catch (error) {
                    alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                }
            }
        }

        async function updateServiceStatus() {
            currentData.serviceStatus.announcement = document.getElementById('serviceAnnouncement').value;

            try {
                const response = await fetch('/api/service-status', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentData.serviceStatus)
                });

                const data = await response.json();
                if (data.success) {
                    alert('„Çµ„Éº„Éì„ÇπÁä∂Ê≥Å„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                    loadServiceStatus();
                }
            } catch (error) {
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            }
        }

        async function addProgress() {
            const applicationId = document.getElementById('progressApplicationSelect').value;
            if (!applicationId) {
                alert('Áî≥Ëæº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const progressData = {
                applicationId: applicationId,
                status: document.getElementById('progressStatus').value,
                description: document.getElementById('progressDescription').value
            };

            try {
                const response = await fetch('/api/progress', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(progressData)
                });

                const data = await response.json();
                if (data.success) {
                    alert('ÈÄ≤Êçó„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                    document.getElementById('progressDescription').value = '';
                    loadProgress();
                    loadApplications();
                }
            } catch (error) {
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            }
        }

        function loadProgressForApplication() {
            const applicationId = document.getElementById('progressApplicationSelect').value;
            if (!applicationId) {
                document.getElementById('progressTimeline').innerHTML = '';
                return;
            }

            const progress = currentData.progress.filter(p => p.applicationId === applicationId);
            document.getElementById('progressTimeline').innerHTML =
                progress.length > 0 ?
                progress.map(p => `
                    <div style="border-left: 3px solid #667eea; padding-left: 20px; margin: 20px 0;">
                        <div style="font-weight: bold;">${getStatusLabel(p.status)}</div>
                        <div style="color: #666; font-size: 12px;">${new Date(p.createdAt).toLocaleString('ja-JP')}</div>
                        <div style="margin-top: 5px;">${p.description}</div>
                    </div>
                `).join('') :
                '<p style="color: #999;">„Åæ„Å†ÈÄ≤ÊçóÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
        }

        // „É¢„Éº„ÉÄ„É´„Éï„Ç©„Éº„É†Ë°®Á§∫Èñ¢Êï∞
        function showApplicationForm() {
            showModal('Êñ∞Ë¶èÁî≥ËæºËøΩÂä†', `
                <div class="form-group">
                    <label>È°ßÂÆ¢Âêç</label>
                    <input type="text" id="newAppCustomerName">
                </div>
                <div class="form-group">
                    <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                    <input type="email" id="newAppCustomerEmail">
                </div>
                <div class="form-group">
                    <label>Áî≥ËæºÂÜÖÂÆπ</label>
                    <textarea id="newAppContent" rows="4"></textarea>
                </div>
                <button class="btn btn-primary" onclick="createApplication()">‰ΩúÊàê</button>
                <button class="btn" onclick="closeModal()">„Ç≠„É£„É≥„Çª„É´</button>
            `);
        }

        function showMessageForm() {
            showModal('Êñ∞Ë¶è„É°„ÉÉ„Çª„Éº„Ç∏', `
                <div class="form-group">
                    <label>ÂÆõÂÖà</label>
                    <select id="newMessageTo">
                        ${currentData.applications.map(app =>
                            `<option value="${app.id}">${app.customerName} - ${app.customerEmail}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>„É°„ÉÉ„Çª„Éº„Ç∏</label>
                    <textarea id="newMessageContent" rows="6"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="newMessageSendEmail"> „É°„Éº„É´„ÅßÈÄÅ‰ø°
                    </label>
                </div>
                <button class="btn btn-primary" onclick="sendMessage()">ÈÄÅ‰ø°</button>
                <button class="btn" onclick="closeModal()">„Ç≠„É£„É≥„Çª„É´</button>
            `);
        }

        function showApprovalForm() {
            showModal('Êñ∞Ë¶èÊâøË™çÁî≥Ë´ã', `
                <div class="form-group">
                    <label>È°ßÂÆ¢Âêç</label>
                    <input type="text" id="newApprovalCustomerName">
                </div>
                <div class="form-group">
                    <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                    <input type="email" id="newApprovalCustomerEmail">
                </div>
                <div class="form-group">
                    <label>„Ç´„Éº„ÉâÂêç</label>
                    <input type="text" id="newApprovalCardName">
                </div>
                <div class="form-group">
                    <label>Ë≤∑Âèñ‰æ°Ê†º</label>
                    <input type="number" id="newApprovalPrice">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="newApprovalSendEmail" checked> „É°„Éº„É´„ÅßÈÄÅ‰ø°
                    </label>
                </div>
                <button class="btn btn-primary" onclick="createApproval()">‰ΩúÊàê</button>
                <button class="btn" onclick="closeModal()">„Ç≠„É£„É≥„Çª„É´</button>
            `);
        }

        // API‰ΩúÊàêÈñ¢Êï∞
        async function createApplication() {
            const applicationData = {
                customerName: document.getElementById('newAppCustomerName').value,
                customerEmail: document.getElementById('newAppCustomerEmail').value,
                content: document.getElementById('newAppContent').value
            };

            try {
                const response = await fetch('/api/applications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(applicationData)
                });

                const data = await response.json();
                if (data.success) {
                    closeModal();
                    loadApplications();
                    loadStatistics();
                }
            } catch (error) {
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            }
        }

        async function sendMessage() {
            const messageData = {
                to: document.getElementById('newMessageTo').value,
                message: document.getElementById('newMessageContent').value,
                sendEmail: document.getElementById('newMessageSendEmail').checked,
                toEmail: currentData.applications.find(a => a.id === document.getElementById('newMessageTo').value)?.customerEmail
            };

            try {
                const response = await fetch('/api/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(messageData)
                });

                const data = await response.json();
                if (data.success) {
                    closeModal();
                    loadMessages();
                }
            } catch (error) {
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            }
        }

        async function createApproval() {
            const approvalData = {
                customerName: document.getElementById('newApprovalCustomerName').value,
                customerEmail: document.getElementById('newApprovalCustomerEmail').value,
                cards: [{
                    name: document.getElementById('newApprovalCardName').value,
                    price: parseFloat(document.getElementById('newApprovalPrice').value)
                }],
                totalPrice: parseFloat(document.getElementById('newApprovalPrice').value),
                sendEmail: document.getElementById('newApprovalSendEmail').checked
            };

            try {
                const response = await fetch('/api/approvals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(approvalData)
                });

                const data = await response.json();
                if (data.success) {
                    closeModal();
                    loadApprovals();
                    loadStatistics();
                }
            } catch (error) {
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            }
        }

        // „Åù„ÅÆ‰ªñ„ÅÆ„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        async function markAsRead(messageId) {
            try {
                const response = await fetch(`/api/messages/${messageId}/read`, {
                    method: 'PUT'
                });

                const data = await response.json();
                if (data.success) {
                    loadMessages();
                    loadStatistics();
                }
            } catch (error) {
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            }
        }

        function viewApplication(id) {
            const app = currentData.applications.find(a => a.id === id);
            if (app) {
                showModal('Áî≥ËæºË©≥Á¥∞', `
                    <div class="form-group">
                        <label>Áî≥ËæºID</label>
                        <div>${app.id}</div>
                    </div>
                    <div class="form-group">
                        <label>È°ßÂÆ¢Âêç</label>
                        <div>${app.customerName}</div>
                    </div>
                    <div class="form-group">
                        <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                        <div>${app.customerEmail}</div>
                    </div>
                    <div class="form-group">
                        <label>Áî≥ËæºÊó•ÊôÇ</label>
                        <div>${new Date(app.createdAt).toLocaleString('ja-JP')}</div>
                    </div>
                    <div class="form-group">
                        <label>„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                        <div><span class="status status-${app.status}">${getStatusLabel(app.status)}</span></div>
                    </div>
                    <button class="btn" onclick="closeModal()">Èñâ„Åò„Çã</button>
                `);
            }
        }

        function viewMessage(id) {
            const msg = currentData.messages.find(m => m.id === id);
            if (msg) {
                showModal('„É°„ÉÉ„Çª„Éº„Ç∏Ë©≥Á¥∞', `
                    <div class="form-group">
                        <label>ÈÄÅ‰ø°Êó•ÊôÇ</label>
                        <div>${new Date(msg.createdAt).toLocaleString('ja-JP')}</div>
                    </div>
                    <div class="form-group">
                        <label>ÈÄÅ‰ø°ËÄÖ</label>
                        <div>${msg.from}</div>
                    </div>
                    <div class="form-group">
                        <label>ÂÆõÂÖà</label>
                        <div>${msg.to}</div>
                    </div>
                    <div class="form-group">
                        <label>„É°„ÉÉ„Çª„Éº„Ç∏</label>
                        <div style="white-space: pre-wrap;">${msg.message}</div>
                    </div>
                    <button class="btn" onclick="closeModal()">Èñâ„Åò„Çã</button>
                `);
                if (!msg.read) {
                    markAsRead(id);
                }
            }
        }

        function viewApproval(id) {
            const approval = currentData.approvals.find(a => a.id === id);
            if (approval) {
                showModal('ÊâøË™çË©≥Á¥∞', `
                    <div class="form-group">
                        <label>ÊâøË™ç„Ç≠„Éº</label>
                        <div style="font-family: monospace; font-size: 18px;">${approval.approvalKey}</div>
                    </div>
                    <div class="form-group">
                        <label>È°ßÂÆ¢Âêç</label>
                        <div>${approval.customerName}</div>
                    </div>
                    <div class="form-group">
                        <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                        <div>${approval.customerEmail}</div>
                    </div>
                    <div class="form-group">
                        <label>Á∑èÈ°ç</label>
                        <div>¬•${(approval.totalPrice || 0).toLocaleString()}</div>
                    </div>
                    <div class="form-group">
                        <label>Áî≥Ë´ãÊó•ÊôÇ</label>
                        <div>${new Date(approval.createdAt).toLocaleString('ja-JP')}</div>
                    </div>
                    <div class="form-group">
                        <label>„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                        <div><span class="status status-${approval.status}">${getStatusLabel(approval.status)}</span></div>
                    </div>
                    <div class="form-group">
                        <label>ÊâøË™çURL</label>
                        <div style="word-break: break-all;">
                            <a href="https://new-daiko-form.onrender.com/approval/${approval.approvalKey}" target="_blank">
                                https://new-daiko-form.onrender.com/approval/${approval.approvalKey}
                            </a>
                        </div>
                    </div>
                    <button class="btn" onclick="closeModal()">Èñâ„Åò„Çã</button>
                `);
            }
        }

        async function deleteApplication(id) {
            if (!confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

            try {
                const response = await fetch(`/api/applications/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    loadApplications();
                    loadStatistics();
                }
            } catch (error) {
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            }
        }

        // ÁîªÈù¢Â§ñ„ÇØ„É™„ÉÉ„ÇØ„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>